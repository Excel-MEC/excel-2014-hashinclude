(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/dialog/dialog"),require("../addon/edit/matchbrackets.js"));else if(typeof define=="function"&&define.amd)define(["../lib/codemirror","../addon/search/searchcursor","../addon/dialog/dialog","../addon/edit/matchbrackets"],e);else e(CodeMirror)})(function(e){"use strict";var r=[{keys:["<Left>"],type:"keyToKey",toKeys:["h"]},{keys:["<Right>"],type:"keyToKey",toKeys:["l"]},{keys:["<Up>"],type:"keyToKey",toKeys:["k"]},{keys:["<Down>"],type:"keyToKey",toKeys:["j"]},{keys:["<Space>"],type:"keyToKey",toKeys:["l"]},{keys:["<BS>"],type:"keyToKey",toKeys:["h"]},{keys:["<C-Space>"],type:"keyToKey",toKeys:["W"]},{keys:["<C-BS>"],type:"keyToKey",toKeys:["B"]},{keys:["<S-Space>"],type:"keyToKey",toKeys:["w"]},{keys:["<S-BS>"],type:"keyToKey",toKeys:["b"]},{keys:["<C-n>"],type:"keyToKey",toKeys:["j"]},{keys:["<C-p>"],type:"keyToKey",toKeys:["k"]},{keys:["<C-[>"],type:"keyToKey",toKeys:["<Esc>"]},{keys:["<C-c>"],type:"keyToKey",toKeys:["<Esc>"]},{keys:["s"],type:"keyToKey",toKeys:["c","l"],context:"normal"},{keys:["s"],type:"keyToKey",toKeys:["x","i"],context:"visual"},{keys:["S"],type:"keyToKey",toKeys:["c","c"],context:"normal"},{keys:["S"],type:"keyToKey",toKeys:["d","c","c"],context:"visual"},{keys:["<Home>"],type:"keyToKey",toKeys:["0"]},{keys:["<End>"],type:"keyToKey",toKeys:["$"]},{keys:["<PageUp>"],type:"keyToKey",toKeys:["<C-b>"]},{keys:["<PageDown>"],type:"keyToKey",toKeys:["<C-f>"]},{keys:["<CR>"],type:"keyToKey",toKeys:["j","^"],context:"normal"},{keys:["H"],type:"motion",motion:"moveToTopLine",motionArgs:{linewise:true,toJumplist:true}},{keys:["M"],type:"motion",motion:"moveToMiddleLine",motionArgs:{linewise:true,toJumplist:true}},{keys:["L"],type:"motion",motion:"moveToBottomLine",motionArgs:{linewise:true,toJumplist:true}},{keys:["h"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:false}},{keys:["l"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:true}},{keys:["j"],type:"motion",motion:"moveByLines",motionArgs:{forward:true,linewise:true}},{keys:["k"],type:"motion",motion:"moveByLines",motionArgs:{forward:false,linewise:true}},{keys:["g","j"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:true}},{keys:["g","k"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:false}},{keys:["w"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:false}},{keys:["W"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:false,bigWord:true}},{keys:["e"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:true,inclusive:true}},{keys:["E"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:true,bigWord:true,inclusive:true}},{keys:["b"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:false}},{keys:["B"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:false,bigWord:true}},{keys:["g","e"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:true,inclusive:true}},{keys:["g","E"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:true,bigWord:true,inclusive:true}},{keys:["{"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:false,toJumplist:true}},{keys:["}"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:true,toJumplist:true}},{keys:["<C-f>"],type:"motion",motion:"moveByPage",motionArgs:{forward:true}},{keys:["<C-b>"],type:"motion",motion:"moveByPage",motionArgs:{forward:false}},{keys:["<C-d>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:true,explicitRepeat:true}},{keys:["<C-u>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:false,explicitRepeat:true}},{keys:["g","g"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:false,explicitRepeat:true,linewise:true,toJumplist:true}},{keys:["G"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:true,explicitRepeat:true,linewise:true,toJumplist:true}},{keys:["0"],type:"motion",motion:"moveToStartOfLine"},{keys:["^"],type:"motion",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["+"],type:"motion",motion:"moveByLines",motionArgs:{forward:true,toFirstChar:true}},{keys:["-"],type:"motion",motion:"moveByLines",motionArgs:{forward:false,toFirstChar:true}},{keys:["_"],type:"motion",motion:"moveByLines",motionArgs:{forward:true,toFirstChar:true,repeatOffset:-1}},{keys:["$"],type:"motion",motion:"moveToEol",motionArgs:{inclusive:true}},{keys:["%"],type:"motion",motion:"moveToMatchedSymbol",motionArgs:{inclusive:true,toJumplist:true}},{keys:["f","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:true,inclusive:true}},{keys:["F","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:false}},{keys:["t","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:true,inclusive:true}},{keys:["T","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:false}},{keys:[";"],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:true}},{keys:[","],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:false}},{keys:["'","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:true,linewise:true}},{keys:["`","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:true}},{keys:["]","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:true}},{keys:["[","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:false}},{keys:["]","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:true,linewise:true}},{keys:["[","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:false,linewise:true}},{keys:["]","p"],type:"action",action:"paste",isEdit:true,actionArgs:{after:true,isEdit:true,matchIndent:true}},{keys:["[","p"],type:"action",action:"paste",isEdit:true,actionArgs:{after:false,isEdit:true,matchIndent:true}},{keys:["]","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:true,toJumplist:true}},{keys:["[","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:false,toJumplist:true}},{keys:["|"],type:"motion",motion:"moveToColumn",motionArgs:{}},{keys:["o"],type:"motion",motion:"moveToOtherHighlightedEnd",motionArgs:{},context:"visual"},{keys:["O"],type:"motion",motion:"moveToOtherHighlightedEnd",motionArgs:{sameLine:true},context:"visual"},{keys:["d"],type:"operator",operator:"delete"},{keys:["y"],type:"operator",operator:"yank"},{keys:["c"],type:"operator",operator:"change"},{keys:[">"],type:"operator",operator:"indent",operatorArgs:{indentRight:true}},{keys:["<"],type:"operator",operator:"indent",operatorArgs:{indentRight:false}},{keys:["g","~"],type:"operator",operator:"swapcase"},{keys:["n"],type:"motion",motion:"findNext",motionArgs:{forward:true,toJumplist:true}},{keys:["N"],type:"motion",motion:"findNext",motionArgs:{forward:false,toJumplist:true}},{keys:["x"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:true},operatorMotionArgs:{visualLine:false}},{keys:["X"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:false},operatorMotionArgs:{visualLine:true}},{keys:["D"],type:"operatorMotion",operator:"delete",motion:"moveToEol",motionArgs:{inclusive:true},operatorMotionArgs:{visualLine:true}},{keys:["Y"],type:"operatorMotion",operator:"yank",motion:"moveToEol",motionArgs:{inclusive:true},operatorMotionArgs:{visualLine:true}},{keys:["C"],type:"operatorMotion",operator:"change",motion:"moveToEol",motionArgs:{inclusive:true},operatorMotionArgs:{visualLine:true}},{keys:["~"],type:"operatorMotion",operator:"swapcase",operatorArgs:{shouldMoveCursor:true},motion:"moveByCharacters",motionArgs:{forward:true}},{keys:["<C-i>"],type:"action",action:"jumpListWalk",actionArgs:{forward:true}},{keys:["<C-o>"],type:"action",action:"jumpListWalk",actionArgs:{forward:false}},{keys:["<C-e>"],type:"action",action:"scroll",actionArgs:{forward:true,linewise:true}},{keys:["<C-y>"],type:"action",action:"scroll",actionArgs:{forward:false,linewise:true}},{keys:["a"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"charAfter"}},{keys:["A"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"eol"}},{keys:["A"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"endOfSelectedArea"},context:"visual"},{keys:["i"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"inplace"}},{keys:["I"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"firstNonBlank"}},{keys:["o"],type:"action",action:"newLineAndEnterInsertMode",isEdit:true,interlaceInsertRepeat:true,actionArgs:{after:true}},{keys:["O"],type:"action",action:"newLineAndEnterInsertMode",isEdit:true,interlaceInsertRepeat:true,actionArgs:{after:false}},{keys:["v"],type:"action",action:"toggleVisualMode"},{keys:["V"],type:"action",action:"toggleVisualMode",actionArgs:{linewise:true}},{keys:["<C-v>"],type:"action",action:"toggleVisualMode",actionArgs:{blockwise:true}},{keys:["g","v"],type:"action",action:"reselectLastSelection"},{keys:["J"],type:"action",action:"joinLines",isEdit:true},{keys:["p"],type:"action",action:"paste",isEdit:true,actionArgs:{after:true,isEdit:true}},{keys:["P"],type:"action",action:"paste",isEdit:true,actionArgs:{after:false,isEdit:true}},{keys:["r","character"],type:"action",action:"replace",isEdit:true},{keys:["@","character"],type:"action",action:"replayMacro"},{keys:["q","character"],type:"action",action:"enterMacroRecordMode"},{keys:["R"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{replace:true}},{keys:["u"],type:"action",action:"undo"},{keys:["u"],type:"action",action:"changeCase",actionArgs:{toLower:true},context:"visual",isEdit:true},{keys:["U"],type:"action",action:"changeCase",actionArgs:{toLower:false},context:"visual",isEdit:true},{keys:["<C-r>"],type:"action",action:"redo"},{keys:["m","character"],type:"action",action:"setMark"},{keys:['"',"character"],type:"action",action:"setRegister"},{keys:["z","z"],type:"action",action:"scrollToCursor",actionArgs:{position:"center"}},{keys:["z","."],type:"action",action:"scrollToCursor",actionArgs:{position:"center"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","t"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"}},{keys:["z","<CR>"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","-"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"}},{keys:["z","b"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["."],type:"action",action:"repeatLastEdit"},{keys:["<C-a>"],type:"action",action:"incrementNumberToken",isEdit:true,actionArgs:{increase:true,backtrack:false}},{keys:["<C-x>"],type:"action",action:"incrementNumberToken",isEdit:true,actionArgs:{increase:false,backtrack:false}},{keys:["a","character"],type:"motion",motion:"textObjectManipulation"},{keys:["i","character"],type:"motion",motion:"textObjectManipulation",motionArgs:{textObjectInner:true}},{keys:["/"],type:"search",searchArgs:{forward:true,querySrc:"prompt",toJumplist:true}},{keys:["?"],type:"search",searchArgs:{forward:false,querySrc:"prompt",toJumplist:true}},{keys:["*"],type:"search",searchArgs:{forward:true,querySrc:"wordUnderCursor",wholeWordOnly:true,toJumplist:true}},{keys:["#"],type:"search",searchArgs:{forward:false,querySrc:"wordUnderCursor",wholeWordOnly:true,toJumplist:true}},{keys:["g","*"],type:"search",searchArgs:{forward:true,querySrc:"wordUnderCursor",toJumplist:true}},{keys:["g","#"],type:"search",searchArgs:{forward:false,querySrc:"wordUnderCursor",toJumplist:true}},{keys:[":"],type:"ex"}];var t=e.Pos;var i=function(){e.defineOption("vimMode",false,function(r,t){if(t){r.setOption("keyMap","vim");r.setOption("disableInput",true);r.setOption("showCursorWhenSelecting",false);e.signal(r,"vim-mode-change",{mode:"normal"});r.on("cursorActivity",ot);R(r);e.on(r.getInputField(),"paste",n(r))}else if(r.state.vim){r.setOption("keyMap","default");r.setOption("disableInput",false);r.off("cursorActivity",ot);e.off(r.getInputField(),"paste",n(r));r.state.vim=null}});function n(e){var r=e.state.vim;if(!r.onPasteFn){r.onPasteFn=function(){if(!r.insertMode){e.setCursor(U(e.getCursor(),0,1));_.enterInsertMode(e,{},r)}}}return r.onPasteFn}var a=/[\d]/;var o=[/\w/,/[^\w\s]/],s=[/\S/];function l(e,r){var t=[];for(var i=e;i<e+r;i++){t.push(String.fromCharCode(i))}return t}var c=l(65,26);var u=l(97,26);var f=l(48,10);var v="~`!@#$%^&*()_-+=[{}]\\|/?.,<>:;\"'".split("");var h=["Left","Right","Up","Down","Space","Backspace","Esc","Home","End","PageUp","PageDown","Enter"];var p=[].concat(c,u,f,["<",">"]);var d=[].concat(c,u,f,["-",'"',".",":","/"]);function m(e,r){return r>=e.firstLine()&&r<=e.lastLine()}function g(e){return/^[a-z]$/.test(e)}function y(e){return"()[]{}".indexOf(e)!=-1}function C(e){return a.test(e)}function k(e){return/^[A-Z]$/.test(e)}function w(e){return/^\s*$/.test(e)}function M(e,r){for(var t=0;t<r.length;t++){if(r[t]==e){return true}}return false}var S={};function x(e,r,t){if(r===undefined){throw Error("defaultValue is required")}if(!t){t="string"}S[e]={type:t,defaultValue:r};A(e,r)}function A(e,r){var t=S[e];if(!t){throw Error("Unknown option: "+e)}if(t.type=="boolean"){if(r&&r!==true){throw Error("Invalid argument: "+e+"="+r)}else if(r!==false){r=true}}t.value=t.type=="boolean"?!!r:r}function b(e){var r=S[e];if(!r){throw Error("Unknown option: "+e)}return r.value}var L=function(){var e=100;var r=-1;var t=0;var i=0;var n=new Array(e);function a(a,o,s){var l=r%e;var c=n[l];function u(t){var i=++r%e;var o=n[i];if(o){o.clear()}n[i]=a.setBookmark(t)}if(c){var f=c.find();if(f&&!z(f,o)){u(o)}}else{u(o)}u(s);t=r;i=r-e+1;if(i<0){i=0}}function o(a,o){r+=o;if(r>t){r=t}else if(r<i){r=i}var s=n[(e+r)%e];if(s&&!s.find()){var l=o>0?1:-1;var c;var u=a.getCursor();do{r+=l;s=n[(e+r)%e];if(s&&(c=s.find())&&!z(u,c)){break}}while(r<t&&r>i)}return s}return{cachedCursor:undefined,add:a,move:o}};var T=function(e){if(e){return{changes:e.changes,expectCursorActivityForChange:e.expectCursorActivityForChange}}return{changes:[],expectCursorActivityForChange:false}};function E(){this.latestRegister=undefined;this.isPlaying=false;this.isRecording=false;this.replaySearchQueries=[];this.onRecordingDone=undefined;this.lastInsertModeChanges=T()}E.prototype={exitMacroRecordMode:function(){var e=B.macroModeState;if(e.onRecordingDone){e.onRecordingDone()}e.onRecordingDone=undefined;e.isRecording=false},enterMacroRecordMode:function(e,r){var t=B.registerController.getRegister(r);if(t){t.clear();this.latestRegister=r;if(e.openDialog){this.onRecordingDone=e.openDialog("(recording)["+r+"]",null,{bottom:true})}this.isRecording=true}}};function R(e){if(!e.state.vim){e.state.vim={inputState:new K,lastEditInputState:undefined,lastEditActionCommand:undefined,lastHPos:-1,lastHSPos:-1,lastMotion:null,marks:{},fakeCursor:null,insertMode:false,insertModeRepeat:undefined,visualMode:false,visualLine:false,visualBlock:false,lastSelection:null,lastPastedText:null,awaitingEscapeSecondCharacter:false}}return e.state.vim}var B;function I(){B={searchQuery:null,searchIsReversed:false,lastSubstituteReplacePart:undefined,jumpList:L(),macroModeState:new E,lastChararacterSearch:{increment:0,forward:true,selectedCharacter:""},registerController:new j({}),searchHistoryController:new H({}),exCommandHistoryController:new H({})};for(var e in S){var r=S[e];r.value=r.defaultValue}}var O={buildKeyMap:function(){},getRegisterController:function(){return B.registerController},resetVimGlobalState_:I,getVimGlobalState_:function(){return B},maybeInitVimState_:R,InsertModeKey:st,map:function(e,r,t){zr.map(e,r,t)},setOption:A,getOption:b,defineOption:x,defineEx:function(e,r,t){if(e.indexOf(r)!==0){throw new Error('(Vim.defineEx) "'+r+'" is not a prefix of "'+e+'", command not registered')}$r[e]=t;zr.commandMap_[r]={name:e,shortName:r,type:"api"}},handleKey:function(t,i){var n;var a=R(t);var o=B.macroModeState;if(o.isRecording){if(i=="q"){o.exitMacroRecordMode();P(t);return}}if(i=="<Esc>"){P(t);if(a.visualMode){sr(t)}return}if(!a.visualMode&&!z(t.getCursor("head"),t.getCursor("anchor"))){a.visualMode=true;a.visualLine=false;e.signal(t,"vim-mode-change",{mode:"visual"});t.on("mousedown",sr)}if(i!="0"||i=="0"&&a.inputState.getRepeat()===0){n=D.matchCommand(i,r,a)}if(!n){if(C(i)){a.inputState.pushRepeatDigit(i)}if(o.isRecording){tt(o,i)}return}if(n.type=="keyToKey"){for(var s=0;s<n.toKeys.length;s++){this.handleKey(t,n.toKeys[s])}}else{if(o.isRecording){tt(o,i)}D.processCommand(t,a,n)}},handleEx:function(e,r){zr.processCommand(e,r)}};function K(){this.prefixRepeat=[];this.motionRepeat=[];this.operator=null;this.operatorArgs=null;this.motion=null;this.motionArgs=null;this.keyBuffer=[];this.registerName=null}K.prototype.pushRepeatDigit=function(e){if(!this.operator){this.prefixRepeat=this.prefixRepeat.concat(e)}else{this.motionRepeat=this.motionRepeat.concat(e)}};K.prototype.getRepeat=function(){var e=0;if(this.prefixRepeat.length>0||this.motionRepeat.length>0){e=1;if(this.prefixRepeat.length>0){e*=parseInt(this.prefixRepeat.join(""),10)}if(this.motionRepeat.length>0){e*=parseInt(this.motionRepeat.join(""),10)}}return e};function P(r,t){r.state.vim.inputState=new K;e.signal(r,"vim-command-done",t)}function N(e,r,t){this.clear();this.keyBuffer=[e||""];this.insertModeChanges=[];this.searchQueries=[];this.linewise=!!r;this.blockwise=!!t}N.prototype={setText:function(e,r,t){this.keyBuffer=[e||""];this.linewise=!!r;this.blockwise=!!t},pushText:function(e,r){if(r){if(!this.linewise){this.keyBuffer.push("\n")}this.linewise=true}this.keyBuffer.push(e)},pushInsertModeChanges:function(e){this.insertModeChanges.push(T(e))},pushSearchQuery:function(e){this.searchQueries.push(e)},clear:function(){this.keyBuffer=[];this.insertModeChanges=[];this.searchQueries=[];this.linewise=false},toString:function(){return this.keyBuffer.join("")}};function j(e){this.registers=e;this.unnamedRegister=e['"']=new N;e["."]=new N;e[":"]=new N;e["/"]=new N}j.prototype={pushText:function(e,r,t,i,n){if(i&&t.charAt(0)=="\n"){t=t.slice(1)+"\n"}if(i&&t.charAt(t.length-1)!=="\n"){t+="\n"}var a=this.isValidRegister(e)?this.getRegister(e):null;if(!a){switch(r){case"yank":this.registers["0"]=new N(t,i,n);break;case"delete":case"change":if(t.indexOf("\n")==-1){this.registers["-"]=new N(t,i)}else{this.shiftNumericRegisters_();this.registers["1"]=new N(t,i)}break}this.unnamedRegister.setText(t,i,n);return}var o=k(e);if(o){a.pushText(t,i)}else{a.setText(t,i,n)}this.unnamedRegister.setText(a.toString(),i)},getRegister:function(e){if(!this.isValidRegister(e)){return this.unnamedRegister}e=e.toLowerCase();if(!this.registers[e]){this.registers[e]=new N}return this.registers[e]},isValidRegister:function(e){return e&&M(e,d)},shiftNumericRegisters_:function(){for(var e=9;e>=2;e--){this.registers[e]=this.getRegister(""+(e-1))}}};function H(){this.historyBuffer=[];this.iterator;this.initialPrefix=null}H.prototype={nextMatch:function(e,r){var t=this.historyBuffer;var i=r?-1:1;if(this.initialPrefix===null)this.initialPrefix=e;for(var n=this.iterator+i;r?n>=0:n<t.length;n+=i){var a=t[n];for(var o=0;o<=a.length;o++){if(this.initialPrefix==a.substring(0,o)){this.iterator=n;return a}}}if(n>=t.length){this.iterator=t.length;return this.initialPrefix}if(n<0)return e},pushInput:function(e){var r=this.historyBuffer.indexOf(e);if(r>-1)this.historyBuffer.splice(r,1);if(e.length)this.historyBuffer.push(e)},reset:function(){this.initialPrefix=null;this.iterator=this.historyBuffer.length}};var D={matchCommand:function(e,r,t){var i=t.inputState;var n=i.keyBuffer.concat(e);var a=[];var o;for(var s=0;s<r.length;s++){var l=r[s];if(q(n,l.keys)){if(i.operator&&l.type=="action"){continue}if(l.keys[n.length-1]=="character"){o=n[n.length-1];if(o.length>1){switch(o){case"<CR>":o="\n";break;case"<Space>":o=" ";break;default:continue}}}a.push(l)}}function c(r){if(n.length<r.keys.length){i.keyBuffer.push(e);return null}else{if(r.keys[n.length-1]=="character"){i.selectedCharacter=o}i.keyBuffer=[];return r}}if(!a.length){i.keyBuffer=[];return null}else if(a.length==1){return c(a[0])}else{var u=t.visualMode?"visual":"normal";var f;for(var s=0;s<a.length;s++){var v=a[s];if(v.context==u){f=v;break}else if(!f&&!v.context){f=v}}return c(f)}},processCommand:function(e,r,t){r.inputState.repeatOverride=t.repeatOverride;switch(t.type){case"motion":this.processMotion(e,r,t);break;case"operator":this.processOperator(e,r,t);break;case"operatorMotion":this.processOperatorMotion(e,r,t);break;case"action":this.processAction(e,r,t);break;case"search":this.processSearch(e,r,t);break;case"ex":case"keyToEx":this.processEx(e,r,t);break;default:break}},processMotion:function(e,r,t){r.inputState.motion=t.motion;r.inputState.motionArgs=J(t.motionArgs);this.evalInput(e,r)},processOperator:function(e,r,t){var i=r.inputState;if(i.operator){if(i.operator==t.operator){i.motion="expandToLine";i.motionArgs={linewise:true};this.evalInput(e,r);return}else{P(e)}}i.operator=t.operator;i.operatorArgs=J(t.operatorArgs);if(r.visualMode){this.evalInput(e,r)}},processOperatorMotion:function(e,r,t){var i=r.visualMode;var n=J(t.operatorMotionArgs);if(n){if(i&&n.visualLine){r.visualLine=true}}this.processOperator(e,r,t);if(!i){this.processMotion(e,r,t)}},processAction:function(e,r,t){var i=r.inputState;var n=i.getRepeat();var a=!!n;var o=J(t.actionArgs)||{};if(i.selectedCharacter){o.selectedCharacter=i.selectedCharacter}if(t.operator){this.processOperator(e,r,t)}if(t.motion){this.processMotion(e,r,t)}if(t.motion||t.operator){this.evalInput(e,r)}o.repeat=n||1;o.repeatIsExplicit=a;o.registerName=i.registerName;P(e);r.lastMotion=null;if(t.isEdit){this.recordLastEdit(r,i,t)}_[t.action](e,o,r)},processSearch:function(r,t,i){if(!r.getSearchCursor){return}var n=i.searchArgs.forward;var a=i.searchArgs.wholeWordOnly;br(r).setReversed(!n);var o=n?"/":"?";var s=br(r).getQuery();var l=r.getScrollInfo();function c(e,n,a){B.searchHistoryController.pushInput(e);B.searchHistoryController.reset();try{Dr(r,e,n,a)}catch(o){Kr(r,"Invalid regex: "+e);return}D.processMotion(r,t,{type:"motion",motion:"findNext",motionArgs:{forward:true,toJumplist:i.searchArgs.toJumplist}})}function u(e){r.scrollTo(l.left,l.top);c(e,true,true);var t=B.macroModeState;if(t.isRecording){nt(t,e)}}function f(t,i,a){var o=e.keyName(t),s;if(o=="Up"||o=="Down"){s=o=="Up"?true:false;i=B.searchHistoryController.nextMatch(i,s)||"";a(i)}else{if(o!="Left"&&o!="Right"&&o!="Ctrl"&&o!="Alt"&&o!="Shift")B.searchHistoryController.reset()}var c;try{c=Dr(r,i,true,true)}catch(t){}if(c){r.scrollIntoView(_r(r,!n,c),30)}else{Vr(r);r.scrollTo(l.left,l.top)}}function v(t,i,n){var a=e.keyName(t);if(a=="Esc"||a=="Ctrl-C"||a=="Ctrl-["){B.searchHistoryController.pushInput(i);B.searchHistoryController.reset();Dr(r,s);Vr(r);r.scrollTo(l.left,l.top);e.e_stop(t);n();r.focus()}}switch(i.searchArgs.querySrc){case"prompt":var h=B.macroModeState;if(h.isPlaying){var p=h.replaySearchQueries.shift();c(p,true,false)}else{jr(r,{onClose:u,prefix:o,desc:Nr,onKeyUp:f,onKeyDown:v})}break;case"wordUnderCursor":var d=fr(r,false,true,false,true);var m=true;if(!d){d=fr(r,false,true,false,false);m=false}if(!d){return}var p=r.getLine(d.start.line).substring(d.start.ch,d.end.ch);if(m&&a){p="\\b"+p+"\\b"}else{p=rr(p)}B.jumpList.cachedCursor=r.getCursor();r.setCursor(d.start);c(p,true,false);break}},processEx:function(r,t,i){function n(e){B.exCommandHistoryController.pushInput(e);B.exCommandHistoryController.reset();zr.processCommand(r,e)}function a(t,i,n){var a=e.keyName(t),o;if(a=="Esc"||a=="Ctrl-C"||a=="Ctrl-["){B.exCommandHistoryController.pushInput(i);B.exCommandHistoryController.reset();e.e_stop(t);n();r.focus()}if(a=="Up"||a=="Down"){o=a=="Up"?true:false;i=B.exCommandHistoryController.nextMatch(i,o)||"";n(i)}else{if(a!="Left"&&a!="Right"&&a!="Ctrl"&&a!="Alt"&&a!="Shift")B.exCommandHistoryController.reset()}}if(i.type=="keyToEx"){zr.processCommand(r,i.exArgs.input)}else{if(t.visualMode){jr(r,{onClose:n,prefix:":",value:"'<,'>",onKeyDown:a})}else{jr(r,{onClose:n,prefix:":",onKeyDown:a})}}},evalInput:function(e,r){var i=r.inputState;var n=i.motion;var a=i.motionArgs||{};var o=i.operator;var s=i.operatorArgs||{};var l=i.registerName;var c=$(e.getCursor("head"));var u=$(e.getCursor("anchor"));var f=$(c);var v=$(f);var h;var p;if(o){this.recordLastEdit(r,i)}if(i.repeatOverride!==undefined){p=i.repeatOverride}else{p=i.getRepeat()}if(p>0&&a.explicitRepeat){a.repeatIsExplicit=true}else if(a.noRepeat||!a.explicitRepeat&&p===0){p=1;a.repeatIsExplicit=false}if(i.selectedCharacter){a.selectedCharacter=s.selectedCharacter=i.selectedCharacter}a.repeat=p;P(e);if(n){var d=F[n](e,a,r);r.lastMotion=F[n];if(!d){return}if(a.toJumplist){var m=B.jumpList;var g=m.cachedCursor;if(g){vr(e,g,d);delete m.cachedCursor}else{vr(e,v,d)}}if(d instanceof Array){f=d[0];h=d[1]}else{h=d}if(!h){h=t(f.line,f.ch)}if(r.visualMode){var y=0;if(Z(u,c)&&(z(u,h)||Z(h,u))){u.ch+=1;y=-1}else if(Z(c,u)&&(z(u,h)||Z(u,h))){u.ch-=1;y=1}if(!r.visualBlock&&!(d instanceof Array)){h.ch+=y}if(r.lastHPos!=Infinity){r.lastHPos=h.ch}c=h;u=d instanceof Array?f:u;if(r.visualLine){if(Z(u,c)){u.ch=0;var C=e.lastLine();if(c.line>C){c.line=C}c.ch=Y(e,c.line)}else{c.ch=0;u.ch=Y(e,u.line)}}else if(r.visualBlock){u=ir(e,c)}if(!r.visualBlock){e.setSelection(u,c)}wr(e,r,"<",Z(u,c)?u:c);wr(e,r,">",Z(u,c)?c:u)}else if(!o){h=V(e,h);e.setCursor(h.line,h.ch)}}if(o){var k=false;r.lastMotion=null;var w=r.lastSelection;s.repeat=p;if(r.visualMode){f=u;h=c;a.inclusive=true;s.shouldMoveCursor=false}if(h&&Z(h,f)){var M=f;f=h;h=M;k=true}else if(!h){h=$(f)}if(a.inclusive&&!r.visualMode){h.ch++}if(s.selOffset){h.line=f.line+s.selOffset.line;if(s.selOffset.line){h.ch=s.selOffset.ch}else{h.ch=f.ch+s.selOffset.ch}if(w&&w.visualBlock){var S=w.visualBlock;var x=S.width;var A=S.height;h=t(f.line+A,f.ch+x);var b=[];for(var L=f.line;L<h.line;L++){var T=t(L,f.ch);var E=t(L,h.ch);var R={anchor:T,head:E};b.push(R)}e.setSelections(b);var I=true}}else if(r.visualMode){var O=t();O.line=h.line-f.line;if(O.line){O.ch=h.ch}else{O.ch=h.ch-f.ch}s.selOffset=O}var K=a.linewise||r.visualMode&&r.visualLine||s.linewise;if(K){cr(e,f,h)}else if(a.forward){lr(e,f,h)}s.registerName=l;s.linewise=K;if(!r.visualBlock&&!I){e.setSelection(f,h)}W[o](e,s,r,f,h,v);if(r.visualMode){sr(e)}}},recordLastEdit:function(e,r,t){var i=B.macroModeState;if(i.isPlaying){return}e.lastEditInputState=r;e.lastEditActionCommand=t;i.lastInsertModeChanges.changes=[];i.lastInsertModeChanges.expectCursorActivityForChange=false}};var F={moveToTopLine:function(e,r){var i=Ur(e).top+r.repeat-1;return t(i,ur(e.getLine(i)))},moveToMiddleLine:function(e){var r=Ur(e);var i=Math.floor((r.top+r.bottom)*.5);return t(i,ur(e.getLine(i)))},moveToBottomLine:function(e,r){var i=Ur(e).bottom-r.repeat+1;return t(i,ur(e.getLine(i)))},expandToLine:function(e,r){var i=e.getCursor();return t(i.line+r.repeat-1,Infinity)},findNext:function(e,r){var t=br(e);var i=t.getQuery();if(!i){return}var n=!r.forward;n=t.isReversed()?!n:n;Wr(e,i);return _r(e,n,i,r.repeat)},goToMark:function(e,r,t){var i=t.marks[r.selectedCharacter];if(i){var n=i.find();return r.linewise?{line:n.line,ch:ur(e.getLine(n.line))}:n}return null},moveToOtherHighlightedEnd:function(e,r,i){var n=e.listSelections();var a=e.getCursor("head");var o=n[0].anchor;var s=z(n[0].head,a)?n.length-1:0;if(r.sameLine&&i.visualBlock){o=t(a.line,n[s].anchor.ch);a=t(n[s].head.line,a.ch)}else{o=n[s].anchor}e.setCursor(a);return[a,o]},jumpToMark:function(e,r,i){var n=e.getCursor();for(var a=0;a<r.repeat;a++){var o=n;for(var s in i.marks){if(!g(s)){continue}var l=i.marks[s].find();var c=r.forward?Z(l,o):Z(o,l);if(c){continue}if(r.linewise&&l.line==o.line){continue}var u=z(o,n);var f=r.forward?G(o,l,n):G(n,l,o);if(u||f){n=l}}}if(r.linewise){n=t(n.line,ur(e.getLine(n.line)))}return n},moveByCharacters:function(e,r){var i=e.getCursor();var n=r.repeat;var a=r.forward?i.ch+n:i.ch-n;return t(i.line,a)},moveByLines:function(e,r,i){var n=e.getCursor();var a=n.ch;switch(i.lastMotion){case this.moveByLines:case this.moveByDisplayLines:case this.moveByScroll:case this.moveToColumn:case this.moveToEol:a=i.lastHPos;break;default:i.lastHPos=a}var o=r.repeat+(r.repeatOffset||0);var s=r.forward?n.line+o:n.line-o;var l=e.firstLine();var c=e.lastLine();if(s<l&&n.line==l||s>c&&n.line==c){return}if(r.toFirstChar){a=ur(e.getLine(s));i.lastHPos=a}i.lastHSPos=e.charCoords(t(s,a),"div").left;return t(s,a)},moveByDisplayLines:function(e,r,i){var n=e.getCursor();switch(i.lastMotion){case this.moveByDisplayLines:case this.moveByScroll:case this.moveByLines:case this.moveToColumn:case this.moveToEol:break;default:i.lastHSPos=e.charCoords(n,"div").left}var a=r.repeat;var o=e.findPosV(n,r.forward?a:-a,"line",i.lastHSPos);if(o.hitSide){if(r.forward){var s=e.charCoords(o,"div");var l={top:s.top+8,left:i.lastHSPos};var o=e.coordsChar(l,"div")}else{var c=e.charCoords(t(e.firstLine(),0),"div");c.left=i.lastHSPos;o=e.coordsChar(c,"div")}}i.lastHPos=o.ch;return o},moveByPage:function(e,r){var t=e.getCursor();var i=r.repeat;return e.findPosV(t,r.forward?i:-i,"page")},moveByParagraph:function(e,r){var i=e.getCursor().line;var n=r.repeat;var a=r.forward?1:-1;for(var o=0;o<n;o++){if(!r.forward&&i===e.firstLine()||r.forward&&i==e.lastLine()){break}i+=a;while(i!==e.firstLine()&&i!=e.lastLine()&&e.getLine(i)){i+=a}}return t(i,0)},moveByScroll:function(e,r,t){var i=e.getScrollInfo();var n=null;var a=r.repeat;if(!a){a=i.clientHeight/(2*e.defaultTextHeight())}var o=e.charCoords(e.getCursor(),"local");r.repeat=a;var n=F.moveByDisplayLines(e,r,t);if(!n){return null}var s=e.charCoords(n,"local");e.scrollTo(null,i.top+s.top-o.top);return n},moveByWords:function(e,r){return yr(e,r.repeat,!!r.forward,!!r.wordEnd,!!r.bigWord)},moveTillCharacter:function(e,r){var t=r.repeat;var i=Cr(e,t,r.forward,r.selectedCharacter);var n=r.forward?-1:1;hr(n,r);if(!i)return null;i.ch+=n;return i},moveToCharacter:function(e,r){var t=r.repeat;hr(0,r);return Cr(e,t,r.forward,r.selectedCharacter)||e.getCursor()},moveToSymbol:function(e,r){var t=r.repeat;return mr(e,t,r.forward,r.selectedCharacter)||e.getCursor()},moveToColumn:function(e,r,t){var i=r.repeat;t.lastHPos=i-1;t.lastHSPos=e.charCoords(e.getCursor(),"div").left;return kr(e,i)},moveToEol:function(e,r,i){var n=e.getCursor();i.lastHPos=Infinity;var a=t(n.line+r.repeat-1,Infinity);var o=e.clipPos(a);o.ch--;i.lastHSPos=e.charCoords(o,"div").left;return a},moveToFirstNonWhiteSpaceCharacter:function(e){var r=e.getCursor();return t(r.line,ur(e.getLine(r.line)))},moveToMatchedSymbol:function(e){var r=e.getCursor();var i=r.line;var n=r.ch;var a=e.getLine(i);var o;do{o=a.charAt(n++);if(o&&y(o)){var s=e.getTokenTypeAt(t(i,n));if(s!=="string"&&s!=="comment"){break}}}while(o);if(o){var l=e.findMatchingBracket(t(i,n));return l.to}else{return r}},moveToStartOfLine:function(e){var r=e.getCursor();return t(r.line,0)},moveToLineOrEdgeOfDocument:function(e,r){var i=r.forward?e.lastLine():e.firstLine();if(r.repeatIsExplicit){i=r.repeat-e.getOption("firstLineNumber")}return t(i,ur(e.getLine(i)))},textObjectManipulation:function(e,r){var t={"(":")",")":"(","{":"}","}":"{","[":"]","]":"["};var i={"'":true,'"':true};var n=r.selectedCharacter;if(n=="b"){n="("}else if(n=="B"){n="{"}var a=!r.textObjectInner;var o;if(t[n]){o=Sr(e,n,a)}else if(i[n]){o=xr(e,n,a)}else if(n==="W"){o=fr(e,a,true,true)}else if(n==="w"){o=fr(e,a,true,false)}else{return null}return[o.start,o.end]},repeatLastCharacterSearch:function(e,r){var t=B.lastChararacterSearch;var i=r.repeat;var n=r.forward===t.forward;var a=(t.increment?1:0)*(n?-1:1);e.moveH(-a,"char");r.inclusive=n?true:false;var o=Cr(e,i,n,t.selectedCharacter);if(!o){e.moveH(a,"char");return e.getCursor()}o.ch+=a;return o}};var W={change:function(e,r,i){var n=e.listSelections();
var a=n[0],o=n[n.length-1];var s=Z(a.anchor,a.head)?a.anchor:a.head;var l=Z(o.anchor,o.head)?o.head:o.anchor;var c=e.getSelection();var u=i.visualBlock;if(i.lastSelection&&!i.visualMode){u=i.lastSelection.visualBlock?true:u}var f=B.macroModeState.lastInsertModeChanges;f.inVisualBlock=u;var v=new Array(n.length).join("1").split("1");var h=i.marks[">"]?i.marks[">"].find():e.getCursor("head");B.registerController.pushText(r.registerName,"change",c,r.linewise);if(r.linewise){if(u){var p=s.line;while(p<=l.line){var d=Y(e,p);var m=t(p,d);var g=t(p,s.ch);p++;e.replaceRange("",g,m)}}else{v="\n";if(l.line==s.line&&l.line==e.lastLine()){v=""}e.replaceRange(v,s,l);e.indentLine(s.line,"smart");s.ch=null;e.setCursor(s)}}else{var c=e.getRange(s,l);if(!w(c)){var y=/\s+$/.exec(c);if(y){l=U(l,0,-y[0].length)}}if(u){e.replaceSelections(v)}else{e.setCursor(s);e.replaceRange("",s,l)}}i.marks[">"]=e.setBookmark(h);_.enterInsertMode(e,{},e.state.vim)},"delete":function(e,r,t){var i=e.listSelections();var n=i[0],a=i[i.length-1];var o=Z(n.anchor,n.head)?n.anchor:n.head;var s=Z(a.anchor,a.head)?a.head:a.anchor;var l,c;var u=t.visualBlock;if(t.visualMode){l=t.marks[">"].find();c=t.marks["<"].find()}else if(t.lastSelection){l=t.lastSelection.curStartMark.find();c=t.lastSelection.curEndMark.find();u=t.lastSelection.visualBlock}var f=e.getSelection();B.registerController.pushText(r.registerName,"delete",f,r.linewise,u);var v=new Array(i.length).join("1").split("1");if(r.linewise&&s.line==e.lastLine()&&o.line==s.line){var h=$(s);o.line--;o.ch=Y(e,o.line);s=h;e.replaceRange("",o,s)}else{e.replaceSelections(v)}if(l){var p=e.setBookmark(c);var d=e.setBookmark(l);if(t.visualMode){t.marks["<"]=p;t.marks[">"]=d}else{t.lastSelection.curStartMark=p;t.lastSelection.curEndMark=d}}if(r.linewise){e.setCursor(F.moveToFirstNonWhiteSpaceCharacter(e))}else{e.setCursor(o)}},indent:function(e,r,t,i,n){var a=i.line;var o=n.line;var s=t.visualMode?r.repeat:1;if(r.linewise){o--}for(var l=a;l<=o;l++){for(var c=0;c<s;c++){e.indentLine(l,r.indentRight)}}e.setCursor(i);e.setCursor(F.moveToFirstNonWhiteSpaceCharacter(e))},swapcase:function(e,r,t,i,n,a){var o=e.getSelections();var s=e.listSelections();var l=[];for(var c=0;c<o.length;c++){var u=o[c];var f="";for(var v=0;v<u.length;v++){var h=u.charAt(v);f+=k(h)?h.toLowerCase():h.toUpperCase()}l.push(f)}e.replaceSelections(l);var p=s[0].anchor;var d=s[0].head;if(!r.shouldMoveCursor){e.setCursor(Z(p,d)?p:d)}},yank:function(e,r,t,i,n,a){var o=e.getSelection();B.registerController.pushText(r.registerName,"yank",o,r.linewise,t.visualBlock);e.setCursor(a)}};var _={jumpListWalk:function(e,r,t){if(t.visualMode){return}var i=r.repeat;var n=r.forward;var a=B.jumpList;var o=a.move(e,n?i:-i);var s=o?o.find():undefined;s=s?s:e.getCursor();e.setCursor(s)},scroll:function(e,r,t){if(t.visualMode){return}var i=r.repeat||1;var n=e.defaultTextHeight();var a=e.getScrollInfo().top;var o=n*i;var s=r.forward?a+o:a-o;var l=$(e.getCursor());var c=e.charCoords(l,"local");if(r.forward){if(s>c.top){l.line+=(s-c.top)/n;l.line=Math.ceil(l.line);e.setCursor(l);c=e.charCoords(l,"local");e.scrollTo(null,c.top)}else{e.scrollTo(null,s)}}else{var u=s+e.getScrollInfo().clientHeight;if(u<c.bottom){l.line-=(c.bottom-u)/n;l.line=Math.floor(l.line);e.setCursor(l);c=e.charCoords(l,"local");e.scrollTo(null,c.bottom-e.getScrollInfo().clientHeight)}else{e.scrollTo(null,s)}}},scrollToCursor:function(e,r){var i=e.getCursor().line;var n=e.charCoords(t(i,0),"local");var a=e.getScrollInfo().clientHeight;var o=n.top;var s=n.bottom-o;switch(r.position){case"center":o=o-a/2+s;break;case"bottom":o=o-a+s*1.4;break;case"top":o=o+s*.4;break}e.scrollTo(null,o)},replayMacro:function(e,r,t){var i=r.selectedCharacter;var n=r.repeat;var a=B.macroModeState;if(i=="@"){i=a.latestRegister}while(n--){rt(e,t,a,i)}},enterMacroRecordMode:function(e,r){var t=B.macroModeState;var i=r.selectedCharacter;t.enterMacroRecordMode(e,i)},enterInsertMode:function(r,i,n){if(r.getOption("readOnly")){return}n.insertMode=true;n.insertModeRepeat=i&&i.repeat||1;var a=i?i.insertAt:null;if(n.visualMode){var o=ar(r,n);var s=o[0];var l=o[1]}if(a=="eol"){var c=r.getCursor();c=t(c.line,Y(r,c.line));r.setCursor(c)}else if(a=="charAfter"){r.setCursor(U(r.getCursor(),0,1))}else if(a=="firstNonBlank"){if(n.visualMode&&!n.visualBlock){if(l.line<s.line){r.setCursor(l)}else{s=t(s.line,0);r.setCursor(s)}r.setCursor(F.moveToFirstNonWhiteSpaceCharacter(r))}else if(n.visualBlock){l=t(l.line,s.ch);r.setCursor(s);ir(r,l)}else{r.setCursor(F.moveToFirstNonWhiteSpaceCharacter(r))}}else if(a=="endOfSelectedArea"){if(n.visualBlock){s=t(s.line,l.ch);r.setCursor(s);ir(r,l)}else if(l.line<s.line){l=t(s.line,0);r.setCursor(l)}}else if(a=="inplace"){if(n.visualMode){return}}r.setOption("keyMap","vim-insert");r.setOption("disableInput",false);if(i&&i.replace){r.toggleOverwrite(true);r.setOption("keyMap","vim-replace");e.signal(r,"vim-mode-change",{mode:"replace"})}else{r.setOption("keyMap","vim-insert");e.signal(r,"vim-mode-change",{mode:"insert"})}if(!B.macroModeState.isPlaying){r.on("change",at);e.on(r.getInputField(),"keydown",lt)}if(n.visualMode){sr(r)}},toggleVisualMode:function(r,i,n){var a=i.repeat;var o=r.getCursor();var s;var l=r.listSelections();if(!n.visualMode){r.on("mousedown",sr);n.visualMode=true;n.visualLine=!!i.linewise;n.visualBlock=!!i.blockwise;if(n.visualLine){o.ch=0;s=V(r,t(o.line+a-1,Y(r,o.line)),true)}else{s=V(r,t(o.line,o.ch+a),true)}r.setSelection(o,s);e.signal(r,"vim-mode-change",{mode:"visual",subMode:n.visualLine?"linewise":""})}else{o=r.getCursor("anchor");s=r.getCursor("head");if(n.visualLine){if(i.blockwise){n.visualBlock=true;ir(r,s);e.signal(r,"vim-mode-change",{mode:"visual",subMode:"blockwise"})}else if(!i.linewise){e.signal(r,"vim-mode-change",{mode:"visual"})}else{sr(r)}n.visualLine=false}else if(n.visualBlock){if(i.linewise){n.visualLine=true;o=t(l[0].anchor.line,0);s=t(l[l.length-1].anchor.line,Y(r,l[l.length-1].anchor.line));r.setSelection(o,s);e.signal(r,"vim-mode-change",{mode:"visual",subMode:"linewise"})}else if(!i.blockwise){if(s!=l[0].head){o=l[0].anchor}else{o=l[l.length-1].anchor}r.setSelection(o,s);e.signal(r,"vim-mode-change",{mode:"visual"})}else{sr(r)}n.visualBlock=false}else if(i.linewise){n.visualLine=true;o.ch=Z(o,s)?0:Y(r,o.line);s.ch=Z(o,s)?Y(r,s.line):0;r.setSelection(o,s);e.signal(r,"vim-mode-change",{mode:"visual",subMode:"linewise"})}else if(i.blockwise){n.visualBlock=true;ir(r,s);e.signal(r,"vim-mode-change",{mode:"visual",subMode:"blockwise"})}else{sr(r)}}wr(r,n,"<",Z(o,s)?o:s);wr(r,n,">",Z(o,s)?s:o)},reselectLastSelection:function(r,t,i){var n=i.marks["<"].find();var a=i.marks[">"].find();var o=i.lastSelection;if(o){var s=o.curStartMark.find();var l=o.curEndMark.find();var c=o.visualBlock;or(r,i,n,a);if(c){r.setCursor(s);s=ir(r,l)}else{r.setSelection(s,l);s=r.getCursor("anchor");l=r.getCursor("head")}if(i.visualMode){wr(r,i,"<",Z(s,l)?s:l);wr(r,i,">",Z(s,l)?l:s)}i.visualMode=true;if(o.visualLine){i.visualLine=true;i.visualBlock=false}else if(o.visualBlock){i.visualLine=false;i.visualBlock=true}else{i.visualBlock=i.visualLine=false}e.signal(r,"vim-mode-change",{mode:"visual",subMode:i.visualLine?"linewise":""})}},joinLines:function(e,r,i){var n,a;if(i.visualMode){n=e.getCursor("anchor");a=e.getCursor("head");a.ch=Y(e,a.line)-1}else{var o=Math.max(r.repeat,2);n=e.getCursor();a=V(e,t(n.line+o-1,Infinity))}var s=0;e.operation(function(){for(var r=n.line;r<a.line;r++){s=Y(e,n.line);var i=t(n.line+1,Y(e,n.line+1));var o=e.getRange(n,i);o=o.replace(/\n\s*/g," ");e.replaceRange(o,n,i)}var l=t(n.line,s);e.setCursor(l)})},newLineAndEnterInsertMode:function(r,i,n){n.insertMode=true;var a=$(r.getCursor());if(a.line===r.firstLine()&&!i.after){r.replaceRange("\n",t(r.firstLine(),0));r.setCursor(r.firstLine(),0)}else{a.line=i.after?a.line:a.line-1;a.ch=Y(r,a.line);r.setCursor(a);var o=e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent;o(r)}this.enterInsertMode(r,{repeat:i.repeat},n)},paste:function(e,r,i){var n=$(e.getCursor());var a=B.registerController.getRegister(r.registerName);var o=a.toString();if(!o){return}if(r.matchIndent){var s=function(r){var t=r.split("	").length-1;var i=r.split(" ").length-1;return t*e.options.tabSize+i*1};var l=e.getLine(e.getCursor().line);var c=s(l.match(/^\s*/)[0]);var u=o.replace(/\n$/,"");var f=o!==u;var v=s(o.match(/^\s*/)[0]);var o=u.replace(/^\s*/gm,function(r){var t=c+(s(r)-v);if(t<0){return""}else if(e.options.indentWithTabs){var i=Math.floor(t/e.options.tabSize);return Array(i+1).join("	")}else{return Array(t+1).join(" ")}});o+=f?"\n":""}if(r.repeat>1){var o=Array(r.repeat+1).join(o)}var h=a.linewise;var p=a.blockwise;if(h){if(i.visualMode){o=i.visualLine?o.slice(0,-1):"\n"+o.slice(0,o.length-1)+"\n"}else if(r.after){o="\n"+o.slice(0,o.length-1);n.ch=Y(e,n.line)}else{n.ch=0}}else{if(p){o=o.split("\n");for(var d=0;d<o.length;d++){o[d]=o[d]==""?" ":o[d]}}n.ch+=r.after?1:0}var m;var g;if(i.visualMode){i.lastPastedText=o;var y;var C=ar(e,i);var k=C[0];var w=C[1];var M=e.getSelection();var S=e.listSelections();var x=new Array(S.length).join("1").split("1");if(i.lastSelection){y=i.lastSelection.curEndMark.find()}B.registerController.unnamedRegister.setText(M);if(p){e.replaceSelections(x);w=t(k.line+o.length-1,k.ch);e.setCursor(k);ir(e,w);e.replaceSelections(o);m=k}else if(i.visualBlock){e.replaceSelections(x);e.setCursor(k);e.replaceRange(o,k,k);m=k}else{e.replaceRange(o,k,w);m=e.posFromIndex(e.indexFromPos(k)+o.length-1)}if(y){i.lastSelection.curEndMark=e.setBookmark(y)}if(h){m.ch=0}}else{if(p){e.setCursor(n);for(var d=0;d<o.length;d++){var A=n.line+d;if(A>e.lastLine()){e.replaceRange("\n",t(A,0))}var b=Y(e,A);if(b<n.ch){tr(e,A,n.ch)}}e.setCursor(n);ir(e,t(n.line+o.length-1,n.ch));e.replaceSelections(o);m=n}else{e.replaceRange(o,n);if(h&&r.after){m=t(n.line+1,ur(e.getLine(n.line+1)))}else if(h&&!r.after){m=t(n.line,ur(e.getLine(n.line)))}else if(!h&&r.after){g=e.indexFromPos(n);m=e.posFromIndex(g+o.length-1)}else{g=e.indexFromPos(n);m=e.posFromIndex(g+o.length)}}}e.setCursor(m);if(i.visualMode){sr(e)}},undo:function(r,t){r.operation(function(){Q(r,e.commands.undo,t.repeat)();r.setCursor(r.getCursor("anchor"))})},redo:function(r,t){Q(r,e.commands.redo,t.repeat)()},setRegister:function(e,r,t){t.inputState.registerName=r.selectedCharacter},setMark:function(e,r,t){var i=r.selectedCharacter;wr(e,t,i,e.getCursor())},replace:function(r,i,n){var a=i.selectedCharacter;var o=r.getCursor();var s;var l;var c=r.listSelections();if(n.visualMode){o=r.getCursor("start");l=r.getCursor("end")}else{var u=r.getLine(o.line);s=o.ch+i.repeat;if(s>u.length){s=u.length}l=t(o.line,s)}if(a=="\n"){if(!n.visualMode)r.replaceRange("",o,l);(e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent)(r)}else{var f=r.getRange(o,l);f=f.replace(/[^\n]/g,a);if(n.visualBlock){var v=new Array(r.options.tabSize+1).join(" ");f=r.getSelection();f=f.replace(/\t/g,v).replace(/[^\n]/g,a).split("\n");r.replaceSelections(f)}else{r.replaceRange(f,o,l)}if(n.visualMode){o=Z(c[0].anchor,c[0].head)?c[0].anchor:c[0].head;r.setCursor(o);sr(r)}else{r.setCursor(U(l,0,-1))}}},incrementNumberToken:function(e,r){var i=e.getCursor();var n=e.getLine(i.line);var a=/-?\d+/g;var o;var s;var l;var c;var u;while((o=a.exec(n))!==null){u=o[0];s=o.index;l=s+u.length;if(i.ch<l)break}if(!r.backtrack&&l<=i.ch)return;if(u){var f=r.increase?1:-1;var v=parseInt(u)+f*r.repeat;var h=t(i.line,s);var p=t(i.line,l);c=v.toString();e.replaceRange(c,h,p)}else{return}e.setCursor(t(i.line,s+c.length-1))},repeatLastEdit:function(e,r,t){var i=t.lastEditInputState;if(!i){return}var n=r.repeat;if(n&&r.repeatIsExplicit){t.lastEditInputState.repeatOverride=n}else{n=t.lastEditInputState.repeatOverride||n}ct(e,t,n,false)},changeCase:function(e,r,t){var i=ar(e,t)[0];var n=e.getSelection();var a;var o;if(t.lastSelection){a=t.lastSelection.curEndMark.find();o=t.lastSelection.visualBlock}var s=r.toLower;n=s?n.toLowerCase():n.toUpperCase();e.replaceSelections(t.visualBlock||o?n.split("\n"):[n]);if(a){t.lastSelection.curEndMark=e.setBookmark(a)}e.setCursor(i);if(t.visualMode){sr(e)}}};function V(e,r,i){var n=Math.min(Math.max(e.firstLine(),r.line),e.lastLine());var a=Y(e,n)-1;a=i?a+1:a;var o=Math.min(Math.max(0,r.ch),a);return t(n,o)}function J(e){var r={};for(var t in e){if(e.hasOwnProperty(t)){r[t]=e[t]}}return r}function U(e,r,i){return t(e.line+r,e.ch+i)}function q(e,r){for(var t=0;t<e.length;t++){if(e[t]!=r[t]&&r[t]!="character"){return false}}return true}function Q(e,r,t){return function(){for(var i=0;i<t;i++){r(e)}}}function $(e){return t(e.line,e.ch)}function z(e,r){return e.ch==r.ch&&e.line==r.line}function Z(e,r){if(e.line<r.line){return true}if(e.line==r.line&&e.ch<r.ch){return true}return false}function G(e,r,t){var i=Z(e,r);var n=Z(r,t);return i&&n}function Y(e,r){return e.getLine(r).length}function X(e){return e.split("").reverse().join("")}function er(e){if(e.trim){return e.trim()}return e.replace(/^\s+|\s+$/g,"")}function rr(e){return e.replace(/([.?*+$\[\]\/\\(){}|\-])/g,"\\$1")}function tr(e,r,i){var n=Y(e,r);var a=new Array(i-n+1).join(" ");e.setCursor(t(r,n));e.replaceRange(a,e.getCursor())}function ir(e,r){var t=[],i=e.listSelections();var n=i[0].anchor,a=i[i.length-1].anchor;var o,s,l,c;var u=e.getCursor("head");var f=$(r);o=n.line;s=a.line;if(r.line<u.line){l="up"}else if(r.line>u.line){l="down"}else{if(r.ch!=u.ch){l=r.ch>u.ch?"right":"left"}c=e.getCursor("anchor")}var v=nr(i,u);r=e.clipPos(r);var h=nr(i,r)<0?false:true;var p=!z(f,r);var d=function(){if(p){if(u.ch>=c.ch){c.ch++}}else if(u.ch==Y(e,u.line)){if(z(i[v].anchor,i[v].head)&&i.length>1){if(l=="up"){if(h||v>0){o=n.line;s=r.line;c=i[v-1].anchor}}else{if(h||v==0){s=a.line;o=r.line;c=i[v+1].anchor}}if(r.ch>=c.ch){c.ch--}}}};switch(l){case"up":o=h?n.line:r.line;s=h?r.line:a.line;c=a;d();break;case"down":o=h?r.line:n.line;s=h?a.line:r.line;c=n;d();break;case"left":if(r.ch<=c.ch&&u.ch>c.ch){c.ch++;r.ch--}break;case"right":if(c.ch<=r.ch&&u.ch<c.ch){c.ch--;r.ch++}break;default:o=c.line;s=r.line}while(o<=s){var m={line:o,ch:c.ch};var g={line:o,ch:r.ch};var y={anchor:m,head:g};t.push(y);if(z(g,r)){v=t.indexOf(y)}o++}r.ch=t[0].head.ch;c.ch=t[0].anchor.ch;if(z(r,t[0].head)){c.line=t[t.length-1].anchor.line}else{c.line=t[0].anchor.line}e.setSelections(t,v);return c}function nr(e,r,t){var i=-1;for(var n=0;n<e.length;n++){var a=z(e[n].anchor,r);var o=z(e[n].head,r);if(t=="head"){i=o?n:i}else if(t=="anchor"){i=a?n:i}else{i=a||o?n:i}}return i}function ar(e,r){var i=r.lastSelection;var n=function(){var r=e.listSelections();var t=r[0];var i=r[r.length-1];var n=Z(t.anchor,t.head)?t.anchor:t.head;var a=Z(i.anchor,i.head)?i.head:i.anchor;return[n,a]};var a=function(){var r=e.getCursor();var n=e.getCursor();var a=i.visualBlock;if(a){var o=a.width;var s=a.height;n=t(r.line+s,r.ch+o);var l=[];for(var c=r.line;c<n.line;c++){var u=t(c,r.ch);var f=t(c,n.ch);var v={anchor:u,head:f};l.push(v)}e.setSelections(l)}else{var h=i.curStartMark.find();var p=i.curEndMark.find();var d=p.line-h.line;var m=p.ch-h.ch;n={line:n.line+d,ch:d?n.ch:m+n.ch};if(i.visualLine){r=t(r.line,0);n=t(n.line,Y(e,n.line))}e.setSelection(r,n)}return[r,n]};if(!r.visualMode){return a()}else{return n()}}function or(e,r,t,i){if(!t||!i){t=r.marks["<"].find()||e.getCursor("anchor");i=r.marks[">"].find()||e.getCursor("head")}if(r.lastPastedText){i=e.posFromIndex(e.indexFromPos(t)+r.lastPastedText.length);r.lastPastedText=null}var n=e.listSelections();var a=nr(n,t,"head")>-1;if(r.visualBlock){var o=Math.abs(t.line-i.line)+1;var s=Math.abs(t.ch-i.ch);var l={height:o,width:s}}r.lastSelection={curStartMark:e.setBookmark(a?i:t),curEndMark:e.setBookmark(a?t:i),visualMode:r.visualMode,visualLine:r.visualLine,visualBlock:l}}function sr(r){r.off("mousedown",sr);var t=r.state.vim;var i=r.getCursor("anchor");var n=r.getCursor("head");if(t.visualBlock&&Z(i,n)){n.ch--}or(r,t);t.visualMode=false;t.visualLine=false;t.visualBlock=false;if(!z(i,n)){r.setCursor(V(r,n))}e.signal(r,"vim-mode-change",{mode:"normal"});if(t.fakeCursor){t.fakeCursor.clear()}}function lr(e,r,t){var i=e.getRange(r,t);if(/\n\s*$/.test(i)){var n=i.split("\n");n.pop();var a;for(var a=n.pop();n.length>0&&a&&w(a);a=n.pop()){t.line--;t.ch=0}if(a){t.line--;t.ch=Y(e,t.line)}else{t.ch=0}}}function cr(e,r,t){r.ch=0;t.ch=0;t.line++}function ur(e){if(!e){return 0}var r=e.search(/\S/);return r==-1?e.length:r}function fr(e,r,i,n,a){var o=e.getCursor();var s=e.getLine(o.line);var l=o.ch;var c=s.substring(l);var u;if(a){u=c.search(/\w/)}else{u=c.search(/\S/)}if(u==-1){return null}l+=u;c=s.substring(l);var f=s.substring(0,l);var v;if(n){v=/^\S+/}else{if(/\w/.test(s.charAt(l))){v=/^\w+/}else{v=/^[^\w\s]+/}}var h=v.exec(c);var p=l;var d=l+h[0].length;var m=X(f);var g=v.exec(m);if(g){p-=g[0].length}if(r){var y=s.substring(d);var C=y.match(/^\s*/)[0].length;if(C>0){d+=C}else{var k=m.length-p;var w=m.substring(k);var M=w.match(/^\s*/)[0].length;p-=M}}return{start:t(o.line,p),end:t(o.line,d)}}function vr(e,r,t){if(!z(r,t)){B.jumpList.add(e,r,t)}}function hr(e,r){B.lastChararacterSearch.increment=e;B.lastChararacterSearch.forward=r.forward;B.lastChararacterSearch.selectedCharacter=r.selectedCharacter}var pr={"(":"bracket",")":"bracket","{":"bracket","}":"bracket","[":"section","]":"section","*":"comment","/":"comment",m:"method",M:"method","#":"preprocess"};var dr={bracket:{isComplete:function(e){if(e.nextCh===e.symb){e.depth++;if(e.depth>=1)return true}else if(e.nextCh===e.reverseSymb){e.depth--}return false}},section:{init:function(e){e.curMoveThrough=true;e.symb=(e.forward?"]":"[")===e.symb?"{":"}"},isComplete:function(e){return e.index===0&&e.nextCh===e.symb}},comment:{isComplete:function(e){var r=e.lastCh==="*"&&e.nextCh==="/";e.lastCh=e.nextCh;return r}},method:{init:function(e){e.symb=e.symb==="m"?"{":"}";e.reverseSymb=e.symb==="{"?"}":"{"},isComplete:function(e){if(e.nextCh===e.symb)return true;return false}},preprocess:{init:function(e){e.index=0},isComplete:function(e){if(e.nextCh==="#"){var r=e.lineText.match(/#(\w+)/)[1];if(r==="endif"){if(e.forward&&e.depth===0){return true}e.depth++}else if(r==="if"){if(!e.forward&&e.depth===0){return true}e.depth--}if(r==="else"&&e.depth===0)return true}return false}}};function mr(e,r,i,n){var a=$(e.getCursor());var o=i?1:-1;var s=i?e.lineCount():-1;var l=a.ch;var c=a.line;var u=e.getLine(c);var f={lineText:u,nextCh:u.charAt(l),lastCh:null,index:l,symb:n,reverseSymb:(i?{")":"(","}":"{"}:{"(":")","{":"}"})[n],forward:i,depth:0,curMoveThrough:false};var v=pr[n];if(!v)return a;var h=dr[v].init;var p=dr[v].isComplete;if(h){h(f)}while(c!==s&&r){f.index+=o;f.nextCh=f.lineText.charAt(f.index);if(!f.nextCh){c+=o;f.lineText=e.getLine(c)||"";if(o>0){f.index=0}else{var d=f.lineText.length;f.index=d>0?d-1:0}f.nextCh=f.lineText.charAt(f.index)}if(p(f)){a.line=c;a.ch=f.index;r--}}if(f.nextCh||f.curMoveThrough){return t(c,f.index)}return a}function gr(e,r,t,i,n){var a=r.line;var l=r.ch;var c=e.getLine(a);var u=t?1:-1;var f=i?s:o;if(n&&c==""){a+=u;c=e.getLine(a);if(!m(e,a)){return null}l=t?0:c.length}while(true){if(n&&c==""){return{from:0,to:0,line:a}}var v=u>0?c.length:-1;var h=v,p=v;while(l!=v){var d=false;for(var g=0;g<f.length&&!d;++g){if(f[g].test(c.charAt(l))){h=l;while(l!=v&&f[g].test(c.charAt(l))){l+=u}p=l;d=h!=p;if(h==r.ch&&a==r.line&&p==h+u){continue}else{return{from:Math.min(h,p+1),to:Math.max(h,p),line:a}}}}if(!d){l+=u}}a+=u;if(!m(e,a)){return null}c=e.getLine(a);l=u>0?0:c.length}throw new Error("The impossible happened.")}function yr(e,r,i,n,a){var o=e.getCursor();var s=$(o);var l=[];if(i&&!n||!i&&n){r++}var c=!(i&&n);for(var u=0;u<r;u++){var f=gr(e,o,i,a,c);if(!f){var v=Y(e,e.lastLine());l.push(i?{line:e.lastLine(),from:v,to:v}:{line:0,from:0,to:0});break}l.push(f);o=t(f.line,i?f.to-1:f.from)}var h=l.length!=r;var p=l[0];var d=l.pop();if(i&&!n){if(!h&&(p.from!=s.ch||p.line!=s.line)){d=l.pop()}return t(d.line,d.from)}else if(i&&n){return t(d.line,d.to-1)}else if(!i&&n){if(!h&&(p.to!=s.ch||p.line!=s.line)){d=l.pop()}return t(d.line,d.to)}else{return t(d.line,d.from)}}function Cr(e,r,i,n){var a=e.getCursor();var o=a.ch;var s;for(var l=0;l<r;l++){var c=e.getLine(a.line);s=Mr(o,c,n,i,true);if(s==-1){return null}o=s}return t(e.getCursor().line,s)}function kr(e,r){var i=e.getCursor().line;return V(e,t(i,r-1))}function wr(e,r,t,i){if(!M(t,p)){return}if(r.marks[t]){r.marks[t].clear()}r.marks[t]=e.setBookmark(i)}function Mr(e,r,t,i,n){var a;if(i){a=r.indexOf(t,e+1);if(a!=-1&&!n){a-=1}}else{a=r.lastIndexOf(t,e-1);if(a!=-1&&!n){a+=1}}return a}function Sr(e,r,i){var n=e.getCursor(),a,o;var s={"(":/[()]/,")":/[()]/,"[":/[[\]]/,"]":/[[\]]/,"{":/[{}]/,"}":/[{}]/}[r];var l={"(":"(",")":"(","[":"[","]":"[","{":"{","}":"{"}[r];var c=e.getLine(n.line).charAt(n.ch);var u=c===l?1:0;a=e.scanForBracket(t(n.line,n.ch+u),-1,null,{bracketRegex:s});o=e.scanForBracket(t(n.line,n.ch+u),1,null,{bracketRegex:s});if(!a||!o){return{start:n,end:n}}a=a.pos;o=o.pos;if(a.line==o.line&&a.ch>o.ch||a.line>o.line){var f=a;a=o;o=f}if(i){o.ch+=1}else{a.ch+=1}return{start:a,end:o}}function xr(e,r,i){var n=$(e.getCursor());var a=e.getLine(n.line);var o=a.split("");var s,l,c,u;var f=o.indexOf(r);if(n.ch<f){n.ch=f}else if(f<n.ch&&o[n.ch]==r){l=n.ch;--n.ch}if(o[n.ch]==r&&!l){s=n.ch+1}else{for(c=n.ch;c>-1&&!s;c--){if(o[c]==r){s=c+1}}}if(s&&!l){for(c=s,u=o.length;c<u&&!l;c++){if(o[c]==r){l=c}}}if(!s||!l){return{start:n,end:n}}if(i){--s;++l}return{start:t(n.line,s),end:t(n.line,l)}}x("pcre",true,"boolean");function Ar(){}Ar.prototype={getQuery:function(){return B.query},setQuery:function(e){B.query=e},getOverlay:function(){return this.searchOverlay},setOverlay:function(e){this.searchOverlay=e},isReversed:function(){return B.isReversed},setReversed:function(e){B.isReversed=e}};function br(e){var r=e.state.vim;return r.searchState_||(r.searchState_=new Ar)}function Lr(e,r,t,i,n){if(e.openDialog){e.openDialog(r,i,{bottom:true,value:n.value,onKeyDown:n.onKeyDown,onKeyUp:n.onKeyUp})}else{i(prompt(t,""))}}function Tr(e){var r=Er(e)||[];if(!r.length)return[];var t=[];if(r[0]!==0)return;for(var i=0;i<r.length;i++){if(typeof r[i]=="number")t.push(e.substring(r[i]+1,r[i+1]))}return t}function Er(e){var r=false;var t=[];for(var i=0;i<e.length;i++){var n=e.charAt(i);if(!r&&n=="/"){t.push(i)}r=!r&&n=="\\"}return t}function Rr(e){var r="|(){";var t="}";var i=false;var n=[];for(var a=-1;a<e.length;a++){var o=e.charAt(a)||"";var s=e.charAt(a+1)||"";var l=s&&r.indexOf(s)!=-1;if(i){if(o!=="\\"||!l){n.push(o)}i=false}else{if(o==="\\"){i=true;if(s&&t.indexOf(s)!=-1){l=true}if(!l||s==="\\"){n.push(o)}}else{n.push(o);if(l&&s!=="\\"){n.push("\\")}}}}return n.join("")}function Br(e){var r=false;var t=[];for(var i=-1;i<e.length;i++){var n=e.charAt(i)||"";var a=e.charAt(i+1)||"";if(r){t.push(n);r=false}else{if(n==="\\"){r=true;if(C(a)||a==="$"){t.push("$")}else if(a!=="/"&&a!=="\\"){t.push("\\")}}else{if(n==="$"){t.push("$")}t.push(n);if(a==="/"){t.push("\\")}}}}return t.join("")}function Ir(r){var t=new e.StringStream(r);var i=[];while(!t.eol()){while(t.peek()&&t.peek()!="\\"){i.push(t.next())}if(t.match("\\/",true)){i.push("/")}else if(t.match("\\\\",true)){i.push("\\")}else{i.push(t.next())}}return i.join("")}function Or(e,r,t){var i=B.registerController.getRegister("/");i.setText(e);if(e instanceof RegExp){return e}var n=Er(e);var a;var o;if(!n.length){a=e}else{a=e.substring(0,n[0]);var s=e.substring(n[0]);o=s.indexOf("i")!=-1}if(!a){return null}if(!b("pcre")){a=Rr(a)}if(t){r=/^[^A-Z]*$/.test(a)}var l=new RegExp(a,r||o?"i":undefined);return l}function Kr(e,r){if(e.openNotification){e.openNotification('<span style="color: red">'+r+"</span>",{bottom:true,duration:5e3})}else{alert(r)}}function Pr(e,r){var t="";if(e){t+='<span style="font-family: monospace">'+e+"</span>"}t+='<input type="text"/> '+'<span style="color: #888">';if(r){t+='<span style="color: #888">';t+=r;t+="</span>"}return t}var Nr="(Javascript regexp)";function jr(e,r){var t=(r.prefix||"")+" "+(r.desc||"");var i=Pr(r.prefix,r.desc);Lr(e,i,t,r.onClose,r)}function Hr(e,r){if(e instanceof RegExp&&r instanceof RegExp){var t=["global","multiline","ignoreCase","source"];for(var i=0;i<t.length;i++){var n=t[i];if(e[n]!==r[n]){return false}}return true}return false}function Dr(e,r,t,i){if(!r){return}var n=br(e);var a=Or(r,!!t,!!i);if(!a){return}Wr(e,a);if(Hr(a,n.getQuery())){return a}n.setQuery(a);return a}function Fr(e){if(e.source.charAt(0)=="^"){var r=true}return{token:function(t){if(r&&!t.sol()){t.skipToEnd();return}var i=t.match(e,false);if(i){if(i[0].length==0){t.next();return"searching"}if(!t.sol()){t.backUp(1);if(!e.exec(t.next()+i[0])){t.next();return null}}t.match(e);return"searching"}while(!t.eol()){t.next();if(t.match(e,false))break}},query:e}}function Wr(e,r){var t=br(e).getOverlay();if(!t||r!=t.query){if(t){e.removeOverlay(t)}t=Fr(r);e.addOverlay(t);br(e).setOverlay(t)}}function _r(e,r,i,n){if(n===undefined){n=1}return e.operation(function(){var a=e.getCursor();var o=e.getSearchCursor(i,a);for(var s=0;s<n;s++){var l=o.find(r);if(s==0&&l&&z(o.from(),a)){l=o.find(r)}if(!l){o=e.getSearchCursor(i,r?t(e.lastLine()):t(e.firstLine(),0));if(!o.find(r)){return}}}return o.from()})}function Vr(e){e.removeOverlay(br(e).getOverlay());br(e).setOverlay(null)}function Jr(e,r,t){if(typeof e!="number"){e=e.line}if(r instanceof Array){return M(e,r)}else{if(t){return e>=r&&e<=t}else{return e==r}}}function Ur(e){var r=e.getScrollInfo();var t=6;var i=10;var n=e.coordsChar({left:0,top:t+r.top},"local");var a=r.clientHeight-i+r.top;var o=e.coordsChar({left:0,top:a},"local");return{top:n.line,bottom:o.line}}var qr=[{name:"map"},{name:"nmap",shortName:"nm"},{name:"vmap",shortName:"vm"},{name:"unmap"},{name:"write",shortName:"w"},{name:"undo",shortName:"u"},{name:"redo",shortName:"red"},{name:"set",shortName:"set"},{name:"sort",shortName:"sor"},{name:"substitute",shortName:"s",possiblyAsync:true},{name:"nohlsearch",shortName:"noh"},{name:"delmarks",shortName:"delm"},{name:"registers",shortName:"reg",excludeFromCommandHistory:true},{name:"global",shortName:"g"}];i.ExCommandDispatcher=function(){this.buildCommandMap_()};i.ExCommandDispatcher.prototype={processCommand:function(r,t,i){var n=r.state.vim;var a=B.registerController.getRegister(":");var o=a.toString();if(n.visualMode){sr(r)}var s=new e.StringStream(t);a.setText(t);var l=i||{};l.input=t;try{this.parseInput_(r,s,l)}catch(c){Kr(r,c);throw c}var u;var f;if(!l.commandName){if(l.line!==undefined){f="move"}}else{u=this.matchCommand_(l.commandName);if(u){f=u.name;if(u.excludeFromCommandHistory){a.setText(o)}this.parseCommandArgs_(s,l,u);if(u.type=="exToKey"){for(var v=0;v<u.toKeys.length;v++){e.Vim.handleKey(r,u.toKeys[v])}return}else if(u.type=="exToEx"){this.processCommand(r,u.toInput);return}}}if(!f){Kr(r,'Not an editor command ":'+t+'"');return}try{$r[f](r,l);if((!u||!u.possiblyAsync)&&l.callback){l.callback()}}catch(c){Kr(r,c);throw c}},parseInput_:function(e,r,t){r.eatWhile(":");if(r.eat("%")){t.line=e.firstLine();t.lineEnd=e.lastLine()}else{t.line=this.parseLineSpec_(e,r);if(t.line!==undefined&&r.eat(",")){t.lineEnd=this.parseLineSpec_(e,r)}}var i=r.match(/^(\w+)/);if(i){t.commandName=i[1]}else{t.commandName=r.match(/.*/)[0]}return t},parseLineSpec_:function(e,r){var t=r.match(/^(\d+)/);if(t){return parseInt(t[1],10)-1}switch(r.next()){case".":return e.getCursor().line;case"$":return e.lastLine();case"'":var i=e.state.vim.marks[r.next()];if(i&&i.find()){return i.find().line}throw new Error("Mark not set");default:r.backUp(1);return undefined}},parseCommandArgs_:function(e,r,t){if(e.eol()){return}r.argString=e.match(/.*/)[0];var i=t.argDelimiter||/\s+/;var n=er(r.argString).split(i);if(n.length&&n[0]){r.args=n}},matchCommand_:function(e){for(var r=e.length;r>0;r--){var t=e.substring(0,r);if(this.commandMap_[t]){var i=this.commandMap_[t];if(i.name.indexOf(e)===0){return i}}}return null},buildCommandMap_:function(){this.commandMap_={};for(var e=0;e<qr.length;e++){var r=qr[e];var t=r.shortName||r.name;this.commandMap_[t]=r}},map:function(e,t,i){if(e!=":"&&e.charAt(0)==":"){if(i){throw Error("Mode not supported for ex mappings")}var n=e.substring(1);if(t!=":"&&t.charAt(0)==":"){this.commandMap_[n]={name:n,type:"exToEx",toInput:t.substring(1),user:true}}else{this.commandMap_[n]={name:n,type:"exToKey",toKeys:Qr(t),user:true}}}else{if(t!=":"&&t.charAt(0)==":"){var a={keys:Qr(e),type:"keyToEx",exArgs:{input:t.substring(1)},user:true};if(i){a.context=i}r.unshift(a)}else{var a={keys:Qr(e),type:"keyToKey",toKeys:Qr(t),user:true};if(i){a.context=i}r.unshift(a)}}},unmap:function(e,t){var i=function(e,r){if(e===r)return true;if(e==null||r==null)return true;if(e.length!=r.length)return false;for(var t=0;t<e.length;t++){if(e[t]!==r[t])return false}return true};if(e!=":"&&e.charAt(0)==":"){if(t){throw Error("Mode not supported for ex mappings")}var n=e.substring(1);if(this.commandMap_[n]&&this.commandMap_[n].user){delete this.commandMap_[n];return}}else{var a=Qr(e);for(var o=0;o<r.length;o++){if(i(a,r[o].keys)&&r[o].context===t&&r[o].user){r.splice(o,1);return}}}throw Error("No such mapping.")}};function Qr(e){var r,t;var i=[];while(e){t=/<\w+-.+?>|<\w+>|./.exec(e);if(t===null)break;r=t[0];e=e.substring(t.index+r.length);i.push(r)}return i}var $r={map:function(e,r,t){var i=r.args;if(!i||i.length<2){if(e){Kr(e,"Invalid mapping: "+r.input)}return}zr.map(i[0],i[1],t)},nmap:function(e,r){this.map(e,r,"normal")},vmap:function(e,r){this.map(e,r,"visual")},unmap:function(e,r,t){var i=r.args;if(!i||i.length<1){if(e){Kr(e,"No such mapping: "+r.input)}return}zr.unmap(i[0],t)},move:function(e,r){D.processCommand(e,e.state.vim,{type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:false,explicitRepeat:true,linewise:true},repeatOverride:r.line+1})},set:function(e,r){var t=r.args;if(!t||t.length<1){if(e){Kr(e,"Invalid mapping: "+r.input)}return}var i=t[0].split("=");var n=i[0];var a=i[1];var o=false;if(n.charAt(n.length-1)=="?"){if(a){throw Error("Trailing characters: "+r.argString)}n=n.substring(0,n.length-1);o=true}if(a===undefined&&n.substring(0,2)=="no"){n=n.substring(2);a=false}var s=S[n]&&S[n].type=="boolean";if(s&&a==undefined){a=true}if(!s&&!a||o){var l=b(n);if(l===true||l===false){Kr(e," "+(l?"":"no")+n)}else{Kr(e,"  "+n+"="+l)}}else{A(n,a)}},registers:function(e,r){var t=r.args;var i=B.registerController.registers;var n="----------Registers----------<br><br>";if(!t){for(var a in i){var o=i[a].toString();if(o.length){n+='"'+a+"    "+o+"<br>"}}}else{var a;t=t.join("");for(var s=0;s<t.length;s++){a=t.charAt(s);if(!B.registerController.isValidRegister(a)){continue}var l=i[a]||new N;n+='"'+a+"    "+l.toString()+"<br>"}}Kr(e,n)},sort:function(r,i){var n,a,o,s;function l(){if(i.argString){var r=new e.StringStream(i.argString);if(r.eat("!")){n=true}if(r.eol()){return}if(!r.eatSpace()){return"Invalid arguments"}var t=r.match(/[a-z]+/);if(t){t=t[0];a=t.indexOf("i")!=-1;o=t.indexOf("u")!=-1;var l=t.indexOf("d")!=-1&&1;var c=t.indexOf("x")!=-1&&1;var u=t.indexOf("o")!=-1&&1;if(l+c+u>1){return"Invalid arguments"}s=l&&"decimal"||c&&"hex"||u&&"octal"}if(r.eatSpace()&&r.match(/\/.*\//)){"patterns not supported"}}}var c=l();if(c){Kr(r,c+": "+i.argString);return}var u=i.line||r.firstLine();var f=i.lineEnd||i.line||r.lastLine();if(u==f){return}var v=t(u,0);var h=t(f,Y(r,f));var p=r.getRange(v,h).split("\n");var d=s=="decimal"?/(-?)([\d]+)/:s=="hex"?/(-?)(?:0x)?([0-9a-f]+)/i:s=="octal"?/([0-7]+)/:null;var m=s=="decimal"?10:s=="hex"?16:s=="octal"?8:null;var g=[],y=[];if(s){for(var C=0;C<p.length;C++){if(d.exec(p[C])){g.push(p[C])}else{y.push(p[C])}}}else{y=p}function k(e,r){if(n){var t;t=e;e=r;r=t}if(a){e=e.toLowerCase();r=r.toLowerCase()}var i=s&&d.exec(e);var o=s&&d.exec(r);if(!i){return e<r?-1:1}i=parseInt((i[1]+i[2]).toLowerCase(),m);o=parseInt((o[1]+o[2]).toLowerCase(),m);return i-o}g.sort(k);y.sort(k);p=!n?y.concat(g):g.concat(y);if(o){var w=p;var M;p=[];for(var C=0;C<w.length;C++){if(w[C]!=M){p.push(w[C])}M=w[C]}}r.replaceRange(p.join("\n"),v,h)},global:function(e,r){var t=r.argString;
if(!t){Kr(e,"Regular Expression missing from global");return}var i=r.line!==undefined?r.line:e.firstLine();var n=r.lineEnd||r.line||e.lastLine();var a=Tr(t);var o=t,s;if(a.length){o=a[0];s=a.slice(1,a.length).join("/")}if(o){try{Dr(e,o,true,true)}catch(l){Kr(e,"Invalid regex: "+o);return}}var c=br(e).getQuery();var u=[],f="";for(var v=i;v<=n;v++){var h=c.test(e.getLine(v));if(h){u.push(v+1);f+=e.getLine(v)+"<br>"}}if(!s){Kr(e,f);return}var p=0;var d=function(){if(p<u.length){var r=u[p]+s;zr.processCommand(e,r,{callback:d})}p++};d()},substitute:function(e,r){if(!e.getSearchCursor){throw new Error("Search feature not available. Requires searchcursor.js or "+"any other getSearchCursor implementation.")}var i=r.argString;var n=i?Tr(i):[];var a,o="",s,l,c;var u=false;var f=false;if(n.length){a=n[0];o=n[1];if(o!==undefined){if(b("pcre")){o=Ir(o)}else{o=Br(o)}B.lastSubstituteReplacePart=o}s=n[2]?n[2].split(" "):[]}else{if(i&&i.length){Kr(e,"Substitutions should be of the form "+":s/pattern/replace/");return}}if(s){l=s[0];c=parseInt(s[1]);if(l){if(l.indexOf("c")!=-1){u=true;l.replace("c","")}if(l.indexOf("g")!=-1){f=true;l.replace("g","")}a=a+"/"+l}}if(a){try{Dr(e,a,true,true)}catch(v){Kr(e,"Invalid regex: "+a);return}}o=o||B.lastSubstituteReplacePart;if(o===undefined){Kr(e,"No previous substitute regular expression");return}var h=br(e);var p=h.getQuery();var d=r.line!==undefined?r.line:e.getCursor().line;var m=r.lineEnd||d;if(c){d=m;m=d+c-1}var g=V(e,t(d,0));var y=e.getSearchCursor(p,g);Zr(e,u,f,d,m,y,p,o,r.callback)},redo:e.commands.redo,undo:e.commands.undo,write:function(r){if(e.commands.save){e.commands.save(r)}else{r.save()}},nohlsearch:function(e){Vr(e)},delmarks:function(r,t){if(!t.argString||!er(t.argString)){Kr(r,"Argument required");return}var i=r.state.vim;var n=new e.StringStream(er(t.argString));while(!n.eol()){n.eatSpace();var a=n.pos;if(!n.match(/[a-zA-Z]/,false)){Kr(r,"Invalid argument: "+t.argString.substring(a));return}var o=n.next();if(n.match("-",true)){if(!n.match(/[a-zA-Z]/,false)){Kr(r,"Invalid argument: "+t.argString.substring(a));return}var s=o;var l=n.next();if(g(s)&&g(l)||k(s)&&k(l)){var c=s.charCodeAt(0);var u=l.charCodeAt(0);if(c>=u){Kr(r,"Invalid argument: "+t.argString.substring(a));return}for(var f=0;f<=u-c;f++){var v=String.fromCharCode(c+f);delete i.marks[v]}}else{Kr(r,"Invalid argument: "+s+"-");return}}else{delete i.marks[o]}}}};var zr=new i.ExCommandDispatcher;function Zr(r,t,i,n,a,o,s,l,c){r.state.vim.exMode=true;var u=false;var f=o.from();function v(){r.operation(function(){while(!u){h();p()}d()})}function h(){var e=r.getRange(o.from(),o.to());var t=e.replace(s,l);o.replace(t)}function p(){var e;while(e=o.findNext()&&Jr(o.from(),n,a)){if(!i&&f&&o.from().line==f.line){continue}r.scrollIntoView(o.from(),30);r.setSelection(o.from(),o.to());f=o.from();u=false;return}u=true}function d(e){if(e){e()}r.focus();if(f){r.setCursor(f);var t=r.state.vim;t.exMode=false;t.lastHPos=t.lastHSPos=f.ch}if(c){c()}}function m(t,i,n){e.e_stop(t);var a=e.keyName(t);switch(a){case"Y":h();p();break;case"N":p();break;case"A":var o=c;c=undefined;r.operation(v);c=o;break;case"L":h();case"Q":case"Esc":case"Ctrl-C":case"Ctrl-[":d(n);break}if(u){d(n)}}p();if(u){Kr(r,"No matches for "+s.source);return}if(!t){v();if(c){c()}return}jr(r,{prefix:"replace with <strong>"+l+"</strong> (y/n/a/q/l)",onKeyDown:m})}function Gr(){function r(e,r){var t=e;if(k(t)&&r=="Ctrl"){t=t.toLowerCase()}if(r){t=r.charAt(0)+"-"+t}var i={Enter:"CR",Backspace:"BS",Delete:"Del"}[t];t=i?i:t;t=t.length>1?"<"+t+">":t;return t}function t(r){return function(t){e.signal(t,"vim-keypress",r);e.Vim.handleKey(t,r)}}var i={nofallthrough:true,style:"fat-cursor"};function n(e,n){for(var a=0;a<e.length;a++){var o=e[a];if(!n&&o.length==1){o="'"+o+"'"}var s=r(e[a],n);var l=n?n+"-"+o:o;i[l]=t(s)}}n(c);n(u);n(c,"Ctrl");n(v);n(v,"Ctrl");n(f);n(f,"Ctrl");n(h);n(h,"Ctrl");return i}e.keyMap.vim=Gr();function Yr(r){var t=r.state.vim;var i=B.macroModeState;var n=B.registerController.getRegister(".");var a=i.isPlaying;var o=i.lastInsertModeChanges;var s=[];if(!a){var l=o.inVisualBlock?t.lastSelection.visualBlock.height:1;var c=o.changes;var s=[];var u=0;while(u<c.length){s.push(c[u]);if(c[u]instanceof st){u++}else{u+=l}}o.changes=s;r.off("change",at);e.off(r.getInputField(),"keydown",lt)}if(!a&&t.insertModeRepeat>1){ct(r,t,t.insertModeRepeat-1,true);t.lastEditInputState.repeatOverride=t.insertModeRepeat}delete t.insertModeRepeat;t.insertMode=false;r.setCursor(r.getCursor().line,r.getCursor().ch-1);r.setOption("keyMap","vim");r.setOption("disableInput",true);r.toggleOverwrite(false);n.setText(o.changes.join(""));e.signal(r,"vim-mode-change",{mode:"normal"});if(i.isRecording){it(i)}}x("enableInsertModeEscKeys",false,"boolean");x("insertModeEscKeys","kj","string");x("insertModeEscKeysTimeout",200,"number");function Xr(r){return function(t){var i=b("insertModeEscKeys");var n=i&&i.length>1&&i.charAt(0);if(!b("enableInsertModeEscKeys")||n!==r){return e.Pass}else{t.replaceRange(r,t.getCursor(),t.getCursor(),"+input");t.setOption("keyMap","await-second");t.state.vim.awaitingEscapeSecondCharacter=true;setTimeout(function(){if(t.state.vim.awaitingEscapeSecondCharacter){t.state.vim.awaitingEscapeSecondCharacter=false;t.setOption("keyMap","vim-insert")}},b("insertModeEscKeysTimeout"))}}}function et(r){return function(t){var i=b("insertModeEscKeys");var n=i&&i.length>1&&i.charAt(1);if(!b("enableInsertModeEscKeys")||n!==r){return e.Pass}else{if(t.state.vim.insertMode){var a=B.macroModeState.lastInsertModeChanges;if(a&&a.changes.length){a.changes.pop()}}t.state.vim.awaitingEscapeSecondCharacter=false;t.replaceRange("",{ch:t.getCursor().ch-1,line:t.getCursor().line},t.getCursor(),"+input");Yr(t)}}}e.keyMap["vim-insert"]={Esc:Yr,"Ctrl-[":Yr,"Ctrl-C":Yr,"Ctrl-N":"autocomplete","Ctrl-P":"autocomplete",Enter:function(r){var t=e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent;t(r)},"'i'":Xr("i"),"'j'":Xr("j"),"'k'":Xr("k"),fallthrough:["default"]};e.keyMap["await-second"]={"'i'":et("i"),"'j'":et("j"),"'k'":et("k"),fallthrough:["vim-insert"]};e.keyMap["vim-replace"]={Backspace:"goCharLeft",fallthrough:["vim-insert"]};function rt(r,t,i,n){var a=B.registerController.getRegister(n);var o=a.keyBuffer;var s=0;i.isPlaying=true;i.replaySearchQueries=a.searchQueries.slice(0);for(var l=0;l<o.length;l++){var c=o[l];var u,f;while(c){u=/<\w+-.+?>|<\w+>|./.exec(c);f=u[0];c=c.substring(u.index+f.length);e.Vim.handleKey(r,f);if(t.insertMode){var v=a.insertModeChanges[s++].changes;B.macroModeState.lastInsertModeChanges.changes=v;ut(r,v,1);Yr(r)}}}i.isPlaying=false}function tt(e,r){if(e.isPlaying){return}var t=e.latestRegister;var i=B.registerController.getRegister(t);if(i){i.pushText(r)}}function it(e){if(e.isPlaying){return}var r=e.latestRegister;var t=B.registerController.getRegister(r);if(t){t.pushInsertModeChanges(e.lastInsertModeChanges)}}function nt(e,r){if(e.isPlaying){return}var t=e.latestRegister;var i=B.registerController.getRegister(t);if(i){i.pushSearchQuery(r)}}function at(e,r){var t=B.macroModeState;var i=t.lastInsertModeChanges;if(!t.isPlaying){while(r){i.expectCursorActivityForChange=true;if(r.origin=="+input"||r.origin=="paste"||r.origin===undefined){var n=r.text.join("\n");i.changes.push(n)}r=r.next}}}function ot(e){var r=e.state.vim;if(r.insertMode){var i=B.macroModeState;if(i.isPlaying){return}var n=i.lastInsertModeChanges;if(n.expectCursorActivityForChange){n.expectCursorActivityForChange=false}else{n.changes=[]}}else if(e.doc.history.lastSelOrigin=="*mouse"){r.lastHPos=e.doc.getCursor().ch;if(e.somethingSelected()){r.visualMode=true}}if(r.visualMode){var a,o;a=o=e.getCursor("head");var s=e.getCursor("anchor");var l=t(o.line,a.ch+(Z(s,o)?-1:1));if(Z(l,a)){var c=a;a=l;l=c}if(r.fakeCursor){r.fakeCursor.clear()}r.fakeCursor=e.markText(a,l,{className:"cm-animate-fat-cursor"})}}function st(e){this.keyName=e}function lt(r){var t=B.macroModeState;var i=t.lastInsertModeChanges;var n=e.keyName(r);function a(){i.changes.push(new st(n));return true}if(n.indexOf("Delete")!=-1||n.indexOf("Backspace")!=-1){e.lookupKey(n,["vim-insert"],a)}}function ct(e,r,t,i){var n=B.macroModeState;n.isPlaying=true;var a=!!r.lastEditActionCommand;var o=r.inputState;function s(){if(a){D.processAction(e,r,r.lastEditActionCommand)}else{D.evalInput(e,r)}}function l(t){if(n.lastInsertModeChanges.changes.length>0){t=!r.lastEditActionCommand?1:t;var i=n.lastInsertModeChanges;ut(e,i.changes,t)}}r.inputState=r.lastEditInputState;if(a&&r.lastEditActionCommand.interlaceInsertRepeat){for(var c=0;c<t;c++){s();l(1)}}else{if(!i){s()}l(t)}r.inputState=o;if(r.insertMode&&!i){Yr(e)}n.isPlaying=false}function ut(r,i,n){function a(t){if(typeof t=="string"){e.commands[t](r)}else{t(r)}return true}var o=r.getCursor();var s=B.macroModeState.lastInsertModeChanges.inVisualBlock;if(s){var l=r.state.vim;var c=l.lastSelection.visualBlock;var u=t(o.line+c.height-1,o.ch);r.setCursor(o);ir(r,u);n=r.listSelections().length;r.setCursor(o)}for(var f=0;f<n;f++){for(var v=0;v<i.length;v++){var h=i[v];if(h instanceof st){e.lookupKey(h.keyName,["vim-insert"],a)}else{var p=r.getCursor();r.replaceRange(h,p,p)}}if(s){o.line++;r.setCursor(o)}}}I();return O};e.Vim=i()});