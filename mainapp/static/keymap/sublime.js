(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets"));else if(typeof define=="function"&&define.amd)define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],e);else e(CodeMirror)})(function(e){"use strict";var t=e.keyMap.sublime={fallthrough:"default"};var n=e.commands;var r=e.Pos;var i=e.keyMap["default"]==e.keyMap.macDefault;var o=i?"Cmd-":"Ctrl-";function a(t,n,i){if(i<0&&n.ch==0)return t.clipPos(r(n.line-1));var o=t.getLine(n.line);if(i>0&&n.ch>=o.length)return t.clipPos(r(n.line+1,0));var a="start",l;for(var s=n.ch,f=i<0?0:o.length,c=0;s!=f;s+=i,c++){var u=o.charAt(i<0?s-1:s);var h=u!="_"&&e.isWordChar(u)?"w":"o";if(h=="w"&&u.toUpperCase()==u)h="W";if(a=="start"){if(h!="o"){a="in";l=h}}else if(a=="in"){if(l!=h){if(l=="w"&&h=="W"&&i<0)s--;if(l=="W"&&h=="w"&&i>0){l="w";continue}break}}}return r(n.line,s)}function l(e,t){e.extendSelectionsBy(function(n){if(e.display.shift||e.doc.extend||n.empty())return a(e.doc,n.head,t);else return t<0?n.from():n.to()})}n[t["Alt-Left"]="goSubwordLeft"]=function(e){l(e,-1)};n[t["Alt-Right"]="goSubwordRight"]=function(e){l(e,1)};n[t[o+"Up"]="scrollLineUp"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top+t.clientHeight,"local");if(e.getCursor().line>=n)e.execCommand("goLineUp")}e.scrollTo(null,t.top-e.defaultTextHeight())};n[t[o+"Down"]="scrollLineDown"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top,"local")+1;if(e.getCursor().line<=n)e.execCommand("goLineDown")}e.scrollTo(null,t.top+e.defaultTextHeight())};n[t["Shift-"+o+"L"]="splitSelectionByLine"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var o=t[i].from(),a=t[i].to();for(var l=o.line;l<=a.line;++l)if(!(a.line>o.line&&l==a.line&&a.ch==0))n.push({anchor:l==o.line?o:r(l,0),head:l==a.line?a:r(l)})}e.setSelections(n,0)};t["Shift-Tab"]="indentLess";n[t["Esc"]="singleSelectionTop"]=function(e){var t=e.listSelections()[0];e.setSelection(t.anchor,t.head,{scroll:false})};n[t[o+"L"]="selectLine"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var o=t[i];n.push({anchor:r(o.from().line,0),head:r(o.to().line+1,0)})}e.setSelections(n)};t["Shift-"+o+"K"]="deleteLine";function s(e,t){e.operation(function(){var n=e.listSelections().length,i=[],o=-1;for(var a=0;a<n;a++){var l=e.listSelections()[a].head;if(l.line<=o)continue;var s=r(l.line+(t?0:1),0);e.replaceRange("\n",s,null,"+insertLine");e.indentLine(s.line,null,true);i.push({head:s,anchor:s});o=l.line+1}e.setSelections(i)})}n[t[o+"Enter"]="insertLineAfter"]=function(e){s(e,false)};n[t["Shift-"+o+"Enter"]="insertLineBefore"]=function(e){s(e,true)};function f(t,n){var i=n.ch,o=i,a=t.getLine(n.line);while(i&&e.isWordChar(a.charAt(i-1)))--i;while(o<a.length&&e.isWordChar(a.charAt(o)))++o;return{from:r(n.line,i),to:r(n.line,o),word:a.slice(i,o)}}n[t[o+"D"]="selectNextOccurrence"]=function(t){var n=t.getCursor("from"),i=t.getCursor("to");var o=t.state.sublimeFindFullWord==t.doc.sel;if(e.cmpPos(n,i)==0){var a=f(t,n);if(!a.word)return;t.setSelection(a.from,a.to);o=true}else{var l=t.getRange(n,i);var s=o?new RegExp("\\b"+l+"\\b"):l;var c=t.getSearchCursor(s,i);if(c.findNext()){t.addSelection(c.from(),c.to())}else{c=t.getSearchCursor(s,r(t.firstLine(),0));if(c.findNext())t.addSelection(c.from(),c.to())}}if(o)t.state.sublimeFindFullWord=t.doc.sel};var c="(){}[]";function u(e){var t=e.getCursor(),n=e.scanForBracket(t,-1);if(!n)return;for(;;){var i=e.scanForBracket(t,1);if(!i)return;if(i.ch==c.charAt(c.indexOf(n.ch)+1)){e.setSelection(r(n.pos.line,n.pos.ch+1),i.pos,false);return true}t=r(i.pos.line,i.pos.ch+1)}}n[t["Shift-"+o+"Space"]="selectScope"]=function(e){u(e)||e.execCommand("selectAll")};n[t["Shift-"+o+"M"]="selectBetweenBrackets"]=function(t){if(!u(t))return e.Pass};n[t[o+"M"]="goToBracket"]=function(t){t.extendSelectionsBy(function(n){var i=t.scanForBracket(n.head,1);if(i&&e.cmpPos(i.pos,n.head)!=0)return i.pos;var o=t.scanForBracket(n.head,-1);return o&&r(o.pos.line,o.pos.ch+1)||n.head})};var h=i?"Cmd-Ctrl-":"Shift-Ctrl-";n[t[h+"Up"]="swapLineUp"]=function(e){var t=e.listSelections(),n=[],i=e.firstLine()-1,o=[];for(var a=0;a<t.length;a++){var l=t[a],s=l.from().line-1,f=l.to().line;o.push({anchor:r(l.anchor.line-1,l.anchor.ch),head:r(l.head.line-1,l.head.ch)});if(l.to().ch==0&&!l.empty())--f;if(s>i)n.push(s,f);else if(n.length)n[n.length-1]=f;i=f}e.operation(function(){for(var t=0;t<n.length;t+=2){var i=n[t],a=n[t+1];var l=e.getLine(i);e.replaceRange("",r(i,0),r(i+1,0),"+swapLine");if(a>e.lastLine())e.replaceRange("\n"+l,r(e.lastLine()),null,"+swapLine");else e.replaceRange(l+"\n",r(a,0),null,"+swapLine")}e.setSelections(o);e.scrollIntoView()})};n[t[h+"Down"]="swapLineDown"]=function(e){var t=e.listSelections(),n=[],i=e.lastLine()+1;for(var o=t.length-1;o>=0;o--){var a=t[o],l=a.to().line+1,s=a.from().line;if(a.to().ch==0&&!a.empty())l--;if(l<i)n.push(l,s);else if(n.length)n[n.length-1]=s;i=s}e.operation(function(){for(var t=n.length-2;t>=0;t-=2){var i=n[t],o=n[t+1];var a=e.getLine(i);if(i==e.lastLine())e.replaceRange("",r(i-1),r(i),"+swapLine");else e.replaceRange("",r(i,0),r(i+1,0),"+swapLine");e.replaceRange(a+"\n",r(o,0),null,"+swapLine")}e.scrollIntoView()})};t[o+"/"]="toggleComment";n[t[o+"J"]="joinLines"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var o=t[i],a=o.from();var l=a.line,s=o.to().line;while(i<t.length-1&&t[i+1].from().line==s)s=t[++i].to().line;n.push({start:l,end:s,anchor:!o.empty()&&a})}e.operation(function(){var t=0,i=[];for(var o=0;o<n.length;o++){var a=n[o];var l=a.anchor&&r(a.anchor.line-t,a.anchor.ch),s;for(var f=a.start;f<=a.end;f++){var c=f-t;if(f==a.end)s=r(c,e.getLine(c).length+1);if(c<e.lastLine()){e.replaceRange(" ",r(c),r(c+1,/^\s*/.exec(e.getLine(c+1))[0].length));++t}}i.push({anchor:l||s,head:s})}e.setSelections(i,0)})};n[t["Shift-"+o+"D"]="duplicateLine"]=function(e){e.operation(function(){var t=e.listSelections().length;for(var n=0;n<t;n++){var i=e.listSelections()[n];if(i.empty())e.replaceRange(e.getLine(i.head.line)+"\n",r(i.head.line,0));else e.replaceRange(e.getRange(i.from(),i.to()),i.from())}e.scrollIntoView()})};t[o+"T"]="transposeChars";function d(e,t){var n=e.listSelections(),i=[],o;for(var a=0;a<n.length;a++){var l=n[a];if(l.empty())continue;var s=l.from().line,f=l.to().line;while(a<n.length-1&&n[a+1].from().line==f)f=l[++a].to().line;i.push(s,f)}if(i.length)o=true;else i.push(e.firstLine(),e.lastLine());e.operation(function(){var n=[];for(var a=0;a<i.length;a+=2){var l=i[a],s=i[a+1];var f=r(l,0),c=r(s);var u=e.getRange(f,c,false);if(t)u.sort();else u.sort(function(e,t){var n=e.toUpperCase(),r=t.toUpperCase();if(n!=r){e=n;t=r}return e<t?-1:e==t?0:1});e.replaceRange(u,f,c);if(o)n.push({anchor:f,head:c})}if(o)e.setSelections(n,0)})}n[t["F9"]="sortLines"]=function(e){d(e,true)};n[t[o+"F9"]="sortLinesInsensitive"]=function(e){d(e,false)};n[t["F2"]="nextBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)while(t.length){var n=t.shift();var r=n.find();if(r){t.push(n);return e.setSelection(r.from,r.to)}}};n[t["Shift-F2"]="prevBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)while(t.length){t.unshift(t.pop());var n=t[t.length-1].find();if(!n)t.pop();else return e.setSelection(n.from,n.to)}};n[t[o+"F2"]="toggleBookmark"]=function(e){var t=e.listSelections();var n=e.state.sublimeBookmarks||(e.state.sublimeBookmarks=[]);for(var r=0;r<t.length;r++){var i=t[r].from(),o=t[r].to();var a=e.findMarks(i,o);for(var l=0;l<a.length;l++){if(a[l].sublimeBookmark){a[l].clear();for(var s=0;s<n.length;s++)if(n[s]==a[l])n.splice(s--,1);break}}if(l==a.length)n.push(e.markText(i,o,{sublimeBookmark:true,clearWhenEmpty:false}))}};n[t["Shift-"+o+"F2"]="clearBookmarks"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(var n=0;n<t.length;n++)t[n].clear();t.length=0};n[t["Alt-F2"]="selectBookmarks"]=function(e){var t=e.state.sublimeBookmarks,n=[];if(t)for(var r=0;r<t.length;r++){var i=t[r].find();if(!i)t.splice(r--,0);else n.push({anchor:i.from,head:i.to})}if(n.length)e.setSelections(n,0)};t["Alt-Q"]="wrapLines";var p=e.keyMap["sublime-Ctrl-K"]={auto:"sublime",nofallthrough:true};t[o+"K"]=function(e){e.setOption("keyMap","sublime-Ctrl-K")};function v(t,n){t.operation(function(){var r=t.listSelections(),i=[],o=[];for(var a=0;a<r.length;a++){var l=r[a];if(l.empty()){i.push(a);o.push("")}else o.push(n(t.getRange(l.from(),l.to())))}t.replaceSelections(o,"around","case");for(var a=i.length-1,s;a>=0;a--){var l=r[i[a]];if(s&&e.cmpPos(l.head,s)>0)continue;var c=f(t,l.head);s=c.from;t.replaceRange(n(c.word),c.from,c.to)}})}p[o+"Backspace"]="delLineLeft";n[p[o+"K"]="delLineRight"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=t.length-1;n>=0;n--)e.replaceRange("",t[n].anchor,r(t[n].to().line),"+delete");e.scrollIntoView()})};n[p[o+"U"]="upcaseAtCursor"]=function(e){v(e,function(e){return e.toUpperCase()})};n[p[o+"L"]="downcaseAtCursor"]=function(e){v(e,function(e){return e.toLowerCase()})};n[p[o+"Space"]="setSublimeMark"]=function(e){if(e.state.sublimeMark)e.state.sublimeMark.clear();e.state.sublimeMark=e.setBookmark(e.getCursor())};n[p[o+"A"]="selectToSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();if(t)e.setSelection(e.getCursor(),t)};n[p[o+"W"]="deleteToSublimeMark"]=function(t){var n=t.state.sublimeMark&&t.state.sublimeMark.find();if(n){var r=t.getCursor(),i=n;if(e.cmpPos(r,i)>0){var o=i;i=r;r=o}t.state.sublimeKilled=t.getRange(r,i);t.replaceRange("",r,i)}};n[p[o+"X"]="swapWithSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();if(t){e.state.sublimeMark.clear();e.state.sublimeMark=e.setBookmark(e.getCursor());e.setCursor(t)}};n[p[o+"Y"]="sublimeYank"]=function(e){if(e.state.sublimeKilled!=null)e.replaceSelection(e.state.sublimeKilled,null,"paste")};p[o+"G"]="clearBookmarks";n[p[o+"C"]="showInCenter"]=function(e){var t=e.cursorCoords(null,"local");e.scrollTo(null,(t.top+t.bottom)/2-e.getScrollInfo().clientHeight/2)};n[t["Shift-Alt-Up"]="selectLinesUpward"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=0;n<t.length;n++){var i=t[n];if(i.head.line>e.firstLine())e.addSelection(r(i.head.line-1,i.head.ch))}})};n[t["Shift-Alt-Down"]="selectLinesDownward"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=0;n<t.length;n++){var i=t[n];if(i.head.line<e.lastLine())e.addSelection(r(i.head.line+1,i.head.ch))}})};function m(t){var n=t.getCursor("from"),r=t.getCursor("to");if(e.cmpPos(n,r)==0){var i=f(t,n);if(!i.word)return;n=i.from;r=i.to}return{from:n,to:r,query:t.getRange(n,r),word:i}}function g(e,t){var n=m(e);if(!n)return;var i=n.query;var o=e.getSearchCursor(i,t?n.to:n.from);if(t?o.findNext():o.findPrevious()){e.setSelection(o.from(),o.to())}else{o=e.getSearchCursor(i,t?r(e.firstLine(),0):e.clipPos(r(e.lastLine())));if(t?o.findNext():o.findPrevious())e.setSelection(o.from(),o.to());else if(n.word)e.setSelection(n.from,n.to)}}n[t[o+"F3"]="findUnder"]=function(e){g(e,true)};n[t["Shift-"+o+"F3"]="findUnderPrevious"]=function(e){g(e,false)};n[t["Alt-F3"]="findAllUnder"]=function(e){var t=m(e);if(!t)return;var n=e.getSearchCursor(t.query);var r=[];var i=-1;while(n.findNext()){r.push({anchor:n.from(),head:n.to()});if(n.from().line<=t.from.line&&n.from().ch<=t.from.ch)i++}e.setSelections(r,i)};t["Shift-"+o+"["]="fold";t["Shift-"+o+"]"]="unfold";p[o+"0"]=p[o+"j"]="unfoldAll";t[o+"I"]="findIncremental";t["Shift-"+o+"I"]="findIncrementalReverse";t[o+"H"]="replace";t["F3"]="findNext";t["Shift-F3"]="findPrev"});