(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],e);else e(CodeMirror)})(function(e){"use strict";e.TernServer=function(e){var t=this;this.options=e||{};var n=this.options.plugins||(this.options.plugins={});if(!n.doc_comment)n.doc_comment=true;if(this.options.useWorker){this.server=new R(this)}else{this.server=new tern.Server({getFile:function(e,n){return r(t,e,n)},async:true,defs:this.options.defs||[],plugins:n})}this.docs=Object.create(null);this.trackChange=function(e,n){s(t,e,n)};this.cachedArgHints=null;this.activeArgHints=null;this.jumpStack=[];this.getHint=function(e,n){return f(t,e,n)};this.getHint.async=true};e.TernServer.prototype={addDoc:function(t,n){var i={doc:n,name:t,changed:null};this.server.addFile(t,O(this,i));e.on(n,"change",this.trackChange);return this.docs[t]=i},delDoc:function(t){var n=a(this,t);if(!n)return;e.off(n.doc,"change",this.trackChange);delete this.docs[n.name];this.server.delFile(n.name)},hideDoc:function(e){L(this);var t=a(this,e);if(t&&t.changed)c(this,t)},complete:function(e){e.showHint({hint:this.getHint})},showType:function(e,t,n){u(this,e,t,n)},updateArgHints:function(e){d(this,e)},jumpToDef:function(e){g(this,e)},jumpBack:function(e){v(this,e)},rename:function(e){x(this,e)},selectName:function(e){b(this,e)},request:function(e,t,n,i){var r=this;var a=o(this,e.getDoc());var s=A(this,a,t,i);this.server.request(s,function(e,i){if(!e&&r.options.responseFilter)i=r.options.responseFilter(a,t,s,e,i);n(e,i)})}};var t=e.Pos;var n="CodeMirror-Tern-";var i=250;function r(e,t,n){var i=e.docs[t];if(i)n(O(e,i));else if(e.options.getFile)e.options.getFile(t,n);else n(null)}function o(e,t,n){for(var i in e.docs){var r=e.docs[i];if(r.doc==t)return r}if(!n)for(var o=0;;++o){i="[doc"+(o||"")+"]";if(!e.docs[i]){n=i;break}}return e.addDoc(n,t)}function a(t,n){if(typeof n=="string")return t.docs[n];if(n instanceof e)n=n.getDoc();if(n instanceof e.Doc)return o(t,n)}function s(e,t,n){var r=o(e,t);var a=e.cachedArgHints;if(a&&a.doc==t&&D(a.start,n.to)<=0)e.cachedArgHints=null;var s=r.changed;if(s==null)r.changed=s={from:n.from.line,to:n.from.line};var f=n.from.line+(n.text.length-1);if(n.from.line<s.to)s.to=s.to-(n.to.line-f);if(f>=s.to)s.to=f+1;if(s.from>n.from.line)s.from=n.from.line;if(t.lineCount()>i&&n.to-s.from>100)setTimeout(function(){if(r.changed&&r.changed.to-r.changed.from>100)c(e,r)},200)}function c(e,t){e.server.request({files:[{type:"full",name:t.name,text:O(e,t)}]},function(e){if(e)window.console.error(e);else t.changed=null})}function f(i,r,o){i.request(r,{type:"completions",types:true,docs:true,urls:true},function(a,s){if(a)return j(i,r,a);var c=[],f="";var u=s.start,d=s.end;if(r.getRange(t(u.line,u.ch-2),u)=='["'&&r.getRange(d,t(d.line,d.ch+2))!='"]')f='"]';for(var p=0;p<s.completions.length;++p){var h=s.completions[p],g=l(h.type);if(s.guess)g+=" "+n+"guess";c.push({text:h.name+f,displayText:h.name,className:g,data:h})}var v={from:u,to:d,list:c};var m=null;e.on(v,"close",function(){q(m)});e.on(v,"update",function(){q(m)});e.on(v,"select",function(e,t){q(m);var r=i.options.completionTip?i.options.completionTip(e.data):e.data.doc;if(r){m=F(t.parentNode.getBoundingClientRect().right+window.pageXOffset,t.getBoundingClientRect().top+window.pageYOffset,r);m.className+=" "+n+"hint-doc"}});o(v)})}function l(e){var t;if(e=="?")t="unknown";else if(e=="number"||e=="string"||e=="bool")t=e;else if(/^fn\(/.test(e))t="fn";else if(/^\[/.test(e))t="array";else t="object";return n+"completion "+n+"completion-"+t}function u(e,t,n,i){e.request(t,"type",function(n,r){if(n)return j(e,t,n);if(e.options.typeTip){var o=e.options.typeTip(r)}else{var o=N("span",null,N("strong",null,r.type||"not found"));if(r.doc)o.appendChild(document.createTextNode(" — "+r.doc));if(r.url){o.appendChild(document.createTextNode(" "));o.appendChild(N("a",null,"[docs]")).href=r.url}}S(t,o);if(i)i()},n)}function d(n,i){L(n);if(i.somethingSelected())return;var r=i.getTokenAt(i.getCursor()).state;var o=e.innerMode(i.getMode(),r);if(o.mode.name!="javascript")return;var a=o.state.lexical;if(a.info!="call")return;var s,c=a.pos||0,f=i.getOption("tabSize");for(var l=i.getCursor().line,u=Math.max(0,l-9),d=false;l>=u;--l){var g=i.getLine(l),v=0;for(var m=0;;){var y=g.indexOf("	",m);if(y==-1)break;v+=f-(y+v)%f-1;m=y+1}s=a.column-v;if(g.charAt(s)=="("){d=true;break}}if(!d)return;var C=t(l,s);var x=n.cachedArgHints;if(x&&x.doc==i.getDoc()&&D(C,x.start)==0)return p(n,i,c);n.request(i,{type:"type",preferFunction:true,end:C},function(e,t){if(e||!t.type||!/^fn\(/.test(t.type))return;n.cachedArgHints={start:m,type:h(t.type),name:t.exprName||t.name||"fn",guess:t.guess,doc:i.getDoc()};p(n,i,c)})}function p(e,t,i){L(e);var r=e.cachedArgHints,o=r.type;var a=N("span",r.guess?n+"fhint-guess":null,N("span",n+"fname",r.name),"(");for(var s=0;s<o.args.length;++s){if(s)a.appendChild(document.createTextNode(", "));var c=o.args[s];a.appendChild(N("span",n+"farg"+(s==i?" "+n+"farg-current":""),c.name||"?"));if(c.type!="?"){a.appendChild(document.createTextNode(": "));a.appendChild(N("span",n+"type",c.type))}}a.appendChild(document.createTextNode(o.rettype?") -> ":")"));if(o.rettype)a.appendChild(N("span",n+"type",o.rettype));var f=t.cursorCoords(null,"page");e.activeArgHints=F(f.right+1,f.bottom,a)}function h(e){var t=[],n=3;function i(t){var i=0,r=n;for(;;){var o=e.charAt(n);if(t.test(o)&&!i)return e.slice(r,n);if(/[{\[\(]/.test(o))++i;else if(/[}\]\)]/.test(o))--i;++n}}if(e.charAt(n)!=")")for(;;){var r=e.slice(n).match(/^([^, \(\[\{]+): /);if(r){n+=r[0].length;r=r[1]}t.push({name:r,type:i(/[\),]/)});if(e.charAt(n)==")")break;n+=2}var o=e.slice(n).match(/^\) -> (.*)$/);return{args:t,rettype:o&&o[1]}}function g(e,t){function n(n){var i={type:"definition",variable:n||null};var r=o(e,t.getDoc());e.server.request(A(e,r,i),function(n,i){if(n)return j(e,t,n);if(!i.file&&i.url){window.open(i.url);return}if(i.file){var o=e.docs[i.file],a;if(o&&(a=y(o.doc,i))){e.jumpStack.push({file:r.name,start:t.getCursor("from"),end:t.getCursor("to")});m(e,r,o,a.start,a.end);return}}j(e,t,"Could not find a definition.")})}if(!C(t))H(t,"Jump to variable",function(e){if(e)n(e)});else n()}function v(e,t){var n=e.jumpStack.pop(),i=n&&e.docs[n.file];if(!i)return;m(e,o(e,t.getDoc()),i,n.start,n.end)}function m(e,t,n,i,r){n.doc.setSelection(i,r);if(t!=n&&e.options.switchToDoc){L(e);e.options.switchToDoc(n.name,n.doc)}}function y(e,n){var i=n.context.slice(0,n.contextOffset).split("\n");var r=n.start.line-(i.length-1);var o=t(r,(i.length==1?n.start.ch:e.getLine(r).length)-i[0].length);var a=e.getLine(r).slice(o.ch);for(var s=r+1;s<e.lineCount()&&a.length<n.context.length;++s)a+="\n"+e.getLine(s);if(a.slice(0,n.context.length)==n.context)return n;var c=e.getSearchCursor(n.context,0,false);var f,l=Infinity;while(c.findNext()){var u=c.from(),d=Math.abs(u.line-o.line)*1e4;if(!d)d=Math.abs(u.ch-o.ch);if(d<l){f=u;l=d}}if(!f)return null;if(i.length==1)f.ch+=i[0].length;else f=t(f.line+(i.length-1),i[i.length-1].length);if(n.start.line==n.end.line)var p=t(f.line,f.ch+(n.end.ch-n.start.ch));else var p=t(f.line+(n.end.line-n.start.line),n.end.ch);return{start:f,end:p}}function C(e){var t=e.getCursor("end"),n=e.getTokenAt(t);if(n.start<t.ch&&(n.type=="comment"||n.type=="string"))return false;return/\w/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function x(e,t){var n=t.getTokenAt(t.getCursor());if(!/\w/.test(n.string))return j(e,t,"Not at a variable");H(t,"New name for "+n.string,function(n){e.request(t,{type:"rename",newName:n,fullDocs:true},function(n,i){if(n)return j(e,t,n);T(e,i.changes)})})}function b(e,t){var n=o(e,t.doc).name;e.request(t,{type:"refs"},function(i,r){if(i)return j(e,t,i);var o=[],a=0;for(var s=0;s<r.refs.length;s++){var c=r.refs[s];if(c.file==n){o.push({anchor:c.start,head:c.end});if(D(a,c.start)>=0&&D(a,c.end)<=0)a=o.length-1}}t.setSelections(o,a)})}var w=0;function T(e,t){var n=Object.create(null);for(var i=0;i<t.length;++i){var r=t[i];(n[r.file]||(n[r.file]=[])).push(r)}for(var o in n){var a=e.docs[o],s=n[o];if(!a)continue;s.sort(function(e,t){return D(t.start,e.start)});var c="*rename"+ ++w;for(var i=0;i<s.length;++i){var r=s[i];a.doc.replaceRange(r.text,r.start,r.end,c)}}}function A(e,n,r,o){var a=[],s=0,c=!r.fullDocs;if(!c)delete r.fullDocs;if(typeof r=="string")r={type:r};r.lineCharPositions=true;if(r.end==null){r.end=o||n.doc.getCursor("end");if(n.doc.somethingSelected())r.start=n.doc.getCursor("start")}var f=r.start||r.end;if(n.changed){if(n.doc.lineCount()>i&&c!==false&&n.changed.to-n.changed.from<100&&n.changed.from<=f.line&&n.changed.to>r.end.line){a.push(k(n,f,r.end));r.file="#0";var s=a[0].offsetLines;if(r.start!=null)r.start=t(r.start.line- -s,r.start.ch);r.end=t(r.end.line-s,r.end.ch)}else{a.push({type:"full",name:n.name,text:O(e,n)});r.file=n.name;n.changed=null}}else{r.file=n.name}for(var l in e.docs){var u=e.docs[l];if(u.changed&&u!=n){a.push({type:"full",name:u.name,text:O(e,u)});u.changed=null}}return{query:r,files:a}}function k(n,i,r){var o=n.doc;var a=null,s=null,c,f=4;for(var l=i.line-1,u=Math.max(0,l-50);l>=u;--l){var d=o.getLine(l),p=d.search(/\bfunction\b/);if(p<0)continue;var h=e.countColumn(d,null,f);if(a!=null&&a<=h)continue;a=h;s=l}if(s==null)s=u;var g=Math.min(o.lastLine(),r.line+20);if(a==null||a==e.countColumn(o.getLine(i.line),null,f))c=g;else for(c=r.line+1;c<g;++c){var h=e.countColumn(o.getLine(c),null,f);if(h<=a)break}var v=t(s,0);return{type:"part",name:n.name,offsetLines:v.line,text:o.getRange(v,t(c,0))}}var D=e.cmpPos;function N(e,t){var n=document.createElement(e);if(t)n.className=t;for(var i=2;i<arguments.length;++i){var r=arguments[i];if(typeof r=="string")r=document.createTextNode(r);n.appendChild(r)}return n}function H(e,t,n){if(e.openDialog)e.openDialog(t+": <input type=text>",n);else n(prompt(t,""))}function S(e,t){var n=e.cursorCoords();var i=F(n.right+1,n.bottom,t);function r(){if(!i.parentNode)return;e.off("cursorActivity",r);M(i)}setTimeout(r,1700);e.on("cursorActivity",r)}function F(e,t,i){var r=N("div",n+"tooltip",i);r.style.left=e+"px";r.style.top=t+"px";document.body.appendChild(r);return r}function q(e){var t=e&&e.parentNode;if(t)t.removeChild(e)}function M(e){e.style.opacity="0";setTimeout(function(){q(e)},1100)}function j(e,t,n){if(e.options.showError)e.options.showError(t,n);else S(t,String(n))}function L(e){if(e.activeArgHints){q(e.activeArgHints);e.activeArgHints=null}}function O(e,t){var n=t.doc.getValue();if(e.options.fileFilter)n=e.options.fileFilter(n,t.name,t.doc);return n}function R(e){var t=new Worker(e.options.workerScript);t.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps});var n=0,i={};function o(e,r){if(r){e.id=++n;i[n]=r}t.postMessage(e)}t.onmessage=function(t){var n=t.data;if(n.type=="getFile"){r(e,n.name,function(e,t){o({type:"getFile",err:String(e),text:t,id:n.id})})}else if(n.type=="debug"){window.console.log(n.message)}else if(n.id&&i[n.id]){i[n.id](n.err,n.body);delete i[n.id]}};t.onerror=function(e){for(var t in i)i[t](e);i={}};this.addFile=function(e,t){o({type:"add",name:e,text:t})};this.delFile=function(e){o({type:"del",name:e})};this.request=function(e,t){o({type:"req",body:e},t)}}});