(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],e);else e(CodeMirror)})(function(e){"use strict";var t=e.Pos;var r="http://www.w3.org/2000/svg";function i(e,t){this.mv=e;this.type=t;this.classes=t=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}i.prototype={constructor:i,init:function(t,r,i){this.edit=this.mv.edit;this.orig=e(t,I({value:r,readOnly:!this.mv.options.allowEditingOriginals},I(i)));this.diff=k(m(r),m(i.value));this.diffOutOfDate=false;this.showDifferences=i.showDifferences!==false;this.forceUpdate=n(this);s(this,true,false);f(this)},setShowDifferences:function(e){e=e!==false;if(e!=this.showDifferences){this.showDifferences=e;this.forceUpdate("full")}}};function o(t){if(t.diffOutOfDate){t.diff=k(t.orig.getValue(),t.edit.getValue());t.diffOutOfDate=false;e.signal(t.edit,"updateDiff",t.diff)}}function n(e){var t={from:0,to:0,marked:[]};var r={from:0,to:0,marked:[]};var i;function n(i){if(i=="full"){if(e.svg)F(e.svg);if(e.copyButtons)F(e.copyButtons);c(e.edit,t.marked,e.classes);c(e.orig,r.marked,e.classes);t.from=t.to=r.from=r.to=0}o(e);if(e.showDifferences){u(e.edit,e.diff,t,DIFF_INSERT,e.classes);u(e.orig,e.diff,r,DIFF_DELETE,e.classes)}h(e)}function f(e){clearTimeout(i);i=setTimeout(n,e==true?250:100)}function l(){if(!e.diffOutOfDate){e.diffOutOfDate=true;t.from=t.to=r.from=r.to=0}f(true)}e.edit.on("change",l);e.orig.on("change",l);e.edit.on("markerAdded",f);e.edit.on("markerCleared",f);e.orig.on("markerAdded",f);e.orig.on("markerCleared",f);e.edit.on("viewportChange",f);e.orig.on("viewportChange",f);n();return n}function f(e){e.edit.on("scroll",function(){l(e,DIFF_INSERT)&&h(e)});e.orig.on("scroll",function(){l(e,DIFF_DELETE)&&h(e)})}function l(e,t){if(e.diffOutOfDate)return false;if(!e.lockScroll)return true;var r,i,o=+new Date;if(t==DIFF_INSERT){r=e.edit;i=e.orig}else{r=e.orig;i=e.edit}if(r.state.scrollSetBy==e&&(r.state.scrollSetAt||0)+50>o)return false;var n=r.getScrollInfo(),f=.5*n.clientHeight,l=n.top+f;var s=r.lineAtHeight(l,"local");var c=M(e.diff,s,t==DIFF_INSERT);var u=a(r,t==DIFF_INSERT?c.edit:c.orig);var d=a(i,t==DIFF_INSERT?c.orig:c.edit);var h=(l-u.top)/(u.bot-u.top);var g=d.top-f+h*(d.bot-d.top);var v,p;if(g>n.top&&(p=n.top/f)<1){g=g*p+n.top*(1-p)}else if((v=n.height-n.clientHeight-n.top)<f){var m=i.getScrollInfo();var C=m.height-m.clientHeight-g;if(C>v&&(p=v/f)<1)g=g*p+(m.height-m.clientHeight-v)*(1-p)}i.scrollTo(n.left,g);i.state.scrollSetAt=o;i.state.scrollSetBy=e;return true}function a(e,t){var r=t.after;if(r==null)r=e.lastLine()+1;return{top:e.heightAtLine(t.before||0,"local"),bot:e.heightAtLine(r,"local")}}function s(e,t,r){e.lockScroll=t;if(t&&r!=false)l(e,DIFF_INSERT)&&h(e);e.lockButton.innerHTML=t?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function c(t,r,i){for(var o=0;o<r.length;++o){var n=r[o];if(n instanceof e.TextMarker){n.clear()}else if(n.parent){t.removeLineClass(n,"background",i.chunk);t.removeLineClass(n,"background",i.start);t.removeLineClass(n,"background",i.end)}}r.length=0}function u(e,t,r,i,o){var n=e.getViewport();e.operation(function(){if(r.from==r.to||n.from-r.to>20||r.from-n.to>20){c(e,r.marked,o);d(e,t,i,r.marked,n.from,n.to,o);r.from=n.from;r.to=n.to}else{if(n.from<r.from){d(e,t,i,r.marked,n.from,r.from,o);r.from=n.from}if(n.to>r.to){d(e,t,i,r.marked,r.to,n.to,o);r.to=n.to}}})}function d(e,r,i,o,n,f,l){var a=t(0,0);var s=t(n,0),c=e.clipPos(t(f-1));var u=i==DIFF_DELETE?l.del:l.insert;function d(t,r){var i=Math.max(n,t),a=Math.min(f,r);for(var s=i;s<a;++s){var c=e.addLineClass(s,"background",l.chunk);if(s==t)e.addLineClass(c,"background",l.start);if(s==r-1)e.addLineClass(c,"background",l.end);o.push(c)}if(t==r&&i==r&&a==r){if(i)o.push(e.addLineClass(i-1,"background",l.end));else o.push(e.addLineClass(i,"background",l.start))}}var h=0;for(var g=0;g<r.length;++g){var v=r[g],p=v[0],m=v[1];if(p==DIFF_EQUAL){var C=a.line+(E(r,g)?0:1);O(a,m);var k=a.line+(D(r,g)?1:0);if(k>C){if(g)d(h,C);h=k}}else{if(p==i){var y=O(a,m,true);var w=T(s,a),M=L(c,y);if(!A(w,M))o.push(e.markText(w,M,{className:u}));a=y}}}if(h<=a.line)d(h,a.line+1)}function h(e){if(!e.showDifferences)return;if(e.svg){F(e.svg);var t=e.gap.offsetWidth;S(e.svg,"width",t,"height",e.gap.offsetHeight)}if(e.copyButtons)F(e.copyButtons);var i=e.type=="left";var o=e.edit.getViewport(),n=e.orig.getViewport();var f=e.edit.getScrollInfo().top,l=e.orig.getScrollInfo().top;y(e.diff,function(a,s,c,u){if(c>o.to||u<o.from||a>n.to||s<n.from)return;var d=e.orig.heightAtLine(a,"local")-l,h=d;if(e.svg){var g=e.edit.heightAtLine(c,"local")-f;if(i){var v=d;d=g;g=v}var p=e.orig.heightAtLine(s,"local")-l;var m=e.edit.heightAtLine(u,"local")-f;if(i){var v=p;p=m;m=v}var C=" C "+t/2+" "+g+" "+t/2+" "+d+" "+(t+2)+" "+d;var k=" C "+t/2+" "+p+" "+t/2+" "+m+" -1 "+m;S(e.svg.appendChild(document.createElementNS(r,"path")),"d","M -1 "+g+C+" L "+(t+2)+" "+p+k+" z","class",e.classes.connect)}if(e.copyButtons){var y=e.copyButtons.appendChild(b("div",e.type=="left"?"⇝":"⇜","CodeMirror-merge-copy"));var w=e.mv.options.allowEditingOriginals;y.title=w?"Push to left":"Revert chunk";y.chunk={topEdit:c,botEdit:u,topOrig:a,botOrig:s};y.style.top=h+"px";if(w){var D=e.orig.heightAtLine(c,"local")-f;var E=e.copyButtons.appendChild(b("div",e.type=="right"?"⇝":"⇜","CodeMirror-merge-copy-reverse"));E.title="Push to right";E.chunk={topEdit:a,botEdit:s,topOrig:c,botOrig:u};E.style.top=D+"px";e.type=="right"?E.style.left="2px":E.style.right="2px"}}})}function g(e,r,i,o){if(e.diffOutOfDate)return;r.replaceRange(i.getRange(t(o.topOrig,0),t(o.botOrig,0)),t(o.topEdit,0),t(o.botEdit,0))}var v=e.MergeView=function(t,r){if(!(this instanceof v))return new v(t,r);this.options=r;var o=r.origLeft,n=r.origRight==null?r.orig:r.origRight;var f=o!=null,l=n!=null;var a=1+(f?1:0)+(l?1:0);var s=[],c=this.left=null,u=this.right=null;if(f){c=this.left=new i(this,"left");var d=b("div",null,"CodeMirror-merge-pane");s.push(d);s.push(p(c))}var g=b("div",null,"CodeMirror-merge-pane");s.push(g);if(l){u=this.right=new i(this,"right");s.push(p(u));var m=b("div",null,"CodeMirror-merge-pane");s.push(m)}(l?m:g).className+=" CodeMirror-merge-pane-rightmost";s.push(b("div",null,null,"height: 0; clear: both;"));var C=this.wrap=t.appendChild(b("div",s,"CodeMirror-merge CodeMirror-merge-"+a+"pane"));this.edit=e(g,I(r));if(c)c.init(d,o,r);if(u)u.init(m,n,r);var k=function(){if(c)h(c);if(u)h(u)};e.on(window,"resize",k);var y=setInterval(function(){for(var t=C.parentNode;t&&t!=document.body;t=t.parentNode){}if(!t){clearInterval(y);e.off(window,"resize",k)}},5e3)};function p(t){var i=t.lockButton=b("div",null,"CodeMirror-merge-scrolllock");i.title="Toggle locked scrolling";var o=b("div",[i],"CodeMirror-merge-scrolllock-wrap");e.on(i,"click",function(){s(t,!t.lockScroll)});var n=[o];if(t.mv.options.revertButtons!==false){t.copyButtons=b("div",null,"CodeMirror-merge-copybuttons-"+t.type);e.on(t.copyButtons,"click",function(e){var r=e.target||e.srcElement;if(!r.chunk)return;if(r.className=="CodeMirror-merge-copy-reverse"){g(t,t.orig,t.edit,r.chunk);return}g(t,t.edit,t.orig,r.chunk)});n.unshift(t.copyButtons)}var f=document.createElementNS&&document.createElementNS(r,"svg");if(f&&!f.createSVGRect)f=null;t.svg=f;if(f)n.push(f);return t.gap=b("div",n,"CodeMirror-merge-gap")}v.prototype={constuctor:v,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(e){if(this.right)this.right.setShowDifferences(e);if(this.left)this.left.setShowDifferences(e)},rightChunks:function(){return this.right&&w(this.right)},leftChunks:function(){return this.left&&w(this.left)}};function m(e){if(typeof e=="string")return e;else return e.getValue()}var C=new diff_match_patch;function k(e,t){var r=C.diff_main(e,t);C.diff_cleanupSemantic(r);for(var i=0;i<r.length;++i){var o=r[i];if(!o[1]){r.splice(i--,1)}else if(i&&r[i-1][0]==o[0]){r.splice(i--,1);r[i][1]+=o[1]}}return r}function y(e,r){var i=0,o=0;var n=t(0,0),f=t(0,0);for(var l=0;l<e.length;++l){var a=e[l],s=a[0];if(s==DIFF_EQUAL){var c=E(e,l)?0:1;var u=n.line+c,d=f.line+c;O(n,a[1],null,f);var h=D(e,l)?1:0;var g=n.line+h,v=f.line+h;if(g>u){if(l)r(o,d,i,u);i=g;o=v}}else{O(s==DIFF_INSERT?n:f,a[1])}}if(i<=n.line||o<=f.line)r(o,f.line+1,i,n.line+1)}function w(e){o(e);var t=[];y(e.diff,function(e,r,i,o){t.push({origFrom:e,origTo:r,editFrom:i,editTo:o})});return t}function D(e,t){if(t==e.length-1)return true;var r=e[t+1][1];if(r.length==1||r.charCodeAt(0)!=10)return false;if(t==e.length-2)return true;r=e[t+2][1];return r.length>1&&r.charCodeAt(0)==10}function E(e,t){if(t==0)return true;var r=e[t-1][1];if(r.charCodeAt(r.length-1)!=10)return false;if(t==1)return true;r=e[t-2][1];return r.charCodeAt(r.length-1)==10}function M(e,t,r){var i,o,n,f;y(e,function(e,l,a,s){var c=r?a:e;var u=r?s:l;if(o==null){if(c>t){o=a;f=e}else if(u>t){o=s;f=l}}if(u<=t){i=s;n=l}else if(c<=t){i=a;n=e}});return{edit:{before:i,after:o},orig:{before:n,after:f}}}function b(e,t,r,i){var o=document.createElement(e);if(r)o.className=r;if(i)o.style.cssText=i;if(typeof t=="string")o.appendChild(document.createTextNode(t));else if(t)for(var n=0;n<t.length;++n)o.appendChild(t[n]);return o}function F(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild)}function S(e){for(var t=1;t<arguments.length;t+=2)e.setAttribute(arguments[t],arguments[t+1])}function I(e,t){if(!t)t={};for(var r in e)if(e.hasOwnProperty(r))t[r]=e[r];return t}function O(e,r,i,o){var n=i?t(e.line,e.ch):e,f=0;for(;;){var l=r.indexOf("\n",f);if(l==-1)break;++n.line;if(o)++o.line;f=l+1}n.ch=(f?0:n.ch)+(r.length-f);if(o)o.ch=(f?0:o.ch)+(r.length-f);return n}function L(e,t){return(e.line-t.line||e.ch-t.ch)<0?e:t}function T(e,t){return(e.line-t.line||e.ch-t.ch)>0?e:t}function A(e,t){return e.line==t.line&&e.ch==t.ch}});